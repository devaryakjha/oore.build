---
title: GitLab Integration
description: Set up GitLab webhooks for automated builds from push events and merge requests
banner:
  content: |
    ⚠️ <strong>Experimental</strong> — Webhooks are received but builds don't run yet. For contributors only.
---

import { Steps, Tabs, TabItem, Aside } from '@astrojs/starlight/components';

<Aside type="caution">
The GitLab integration can receive webhooks and store events, but **build execution is not implemented**. Setting this up will not give you working CI/CD.
</Aside>

Oore integrates with GitLab using:

- **Webhooks**: For receiving push and merge request events
- **OAuth**: For cloning private repositories and automatic webhook management

GitLab webhooks use token-based authentication (simpler than GitHub's HMAC signatures).

## Quick Setup (OAuth)

The recommended way to set up GitLab is using OAuth, which automatically creates webhooks.

<Steps>

1. **Create GitLab OAuth Application**

   <Tabs>
     <TabItem label="gitlab.com">
       Configure environment variables on the server:

       ```bash
       # /etc/oore/oore.env
       OORE_GITLAB_CLIENT_ID=your-application-id
       OORE_GITLAB_CLIENT_SECRET=your-application-secret
       ```

       Create the application at GitLab → Settings → Applications with:

       | Field | Value |
       |-------|-------|
       | Name | Oore CI |
       | Redirect URI | `https://your-server.com/setup/gitlab/callback` |
       | Confidential | Yes |
       | Scopes | `api`, `read_repository` |
     </TabItem>
     <TabItem label="Self-Hosted">
       Create the OAuth application in your GitLab instance, then register it:

       ```bash
       oore gitlab register \
         --instance https://gitlab.mycompany.com \
         --client-id YOUR_CLIENT_ID \
         --client-secret YOUR_CLIENT_SECRET
       ```
     </TabItem>
   </Tabs>

2. **Run setup**

   ```bash
   # For gitlab.com (or if only one instance is configured)
   oore gitlab setup

   # For self-hosted GitLab
   oore gitlab setup --instance https://gitlab.mycompany.com
   ```

   This opens your browser for OAuth authorization. Once authorized, the CLI automatically detects completion.

3. **Enable CI for projects**

   ```bash
   # List accessible projects
   oore gitlab projects

   # Enable CI for a project (creates repository and webhook automatically)
   oore gitlab enable 12345678
   ```

4. **Push code**

   ```bash
   git push origin main
   oore build list
   ```

</Steps>

## Commands Reference

### Setup and Authentication

```bash
# Run OAuth setup (opens browser, polls for completion)
oore gitlab setup
oore gitlab setup --instance https://gitlab.mycompany.com

# Show credentials status
oore gitlab status

# Refresh OAuth token
oore gitlab refresh

# Remove credentials
oore gitlab remove <CREDENTIALS_ID> --force
```

### Project Management

```bash
# List accessible projects
oore gitlab projects
oore gitlab projects --page 2 --per-page 50

# Enable CI for a project
oore gitlab enable <PROJECT_ID>

# Disable CI for a project
oore gitlab disable <PROJECT_ID>
```

:::tip[Instance Auto-Detection]
When only one GitLab instance is configured, `--instance` is optional. The CLI will auto-detect it.

When multiple instances are configured, you must specify `--instance` or you'll see a list of available instances.
:::

:::tip[Automatic Token Refresh]
The web dashboard automatically refreshes expired GitLab OAuth tokens when you select a GitLab instance in the Add Repository form. You'll see a "Refreshing token..." message while this happens.

If automatic refresh fails, you can manually refresh from **Settings → GitLab** or via CLI with `oore gitlab refresh`.
:::

## How It Works

```
GitLab                          oored                      Build
  │                               │                          │
  │  POST /webhooks/gitlab/:id    │                          │
  ├──────────────────────────────▶│                          │
  │                               │ 1. Verify token          │
  │                               │ 2. Store event           │
  │                               │ 3. Queue for processing  │
  │        {"status":"ok"}        │                          │
  │◀──────────────────────────────┤                          │
```

### Security: Token Storage

GitLab tokens are stored securely:

1. Token sent in `X-Gitlab-Token` header
2. Oore stores `HMAC-SHA256(token, pepper)` in database
3. On verification, compute HMAC and compare

:::note
Even if the database is compromised, original tokens cannot be recovered.
:::

### Event Types

| Event | Trigger |
|-------|---------|
| Push Hook | Code pushed |
| Merge Request Hook | MR opened/updated/merged |
| Tag Push Hook | New tag created |

## GitLab.com vs Self-Hosted

<Tabs>
  <TabItem label="GitLab.com">
    Configure environment variables for OAuth:
    ```bash
    OORE_GITLAB_CLIENT_ID=your-app-id
    OORE_GITLAB_CLIENT_SECRET=your-app-secret
    ```

    Then run:
    ```bash
    oore gitlab setup
    ```
  </TabItem>
  <TabItem label="Self-Hosted">
    Register OAuth app credentials via CLI:
    ```bash
    oore gitlab register \
      --instance https://gitlab.mycompany.com \
      --client-id YOUR_CLIENT_ID \
      --client-secret YOUR_CLIENT_SECRET
    ```

    Then run:
    ```bash
    oore gitlab setup --instance https://gitlab.mycompany.com
    ```

    Optional security settings in `/etc/oore/oore.env`:
    ```bash
    OORE_GITLAB_ALLOWED_HOSTS=gitlab.mycompany.com,gitlab.internal.com
    OORE_GITLAB_CA_BUNDLE=/etc/ssl/certs/internal-ca.pem
    ```
  </TabItem>
</Tabs>

## Troubleshooting

### Webhooks Not Received

- Check URL is publicly accessible
- Token must match exactly (case-sensitive)
- SSL certificate must be valid

View logs in GitLab → Settings → Webhooks → Recent events

### Token Verification Failures

```bash
# Update token in Oore
oore repo add --provider gitlab --owner myuser --repo my-project \
  --webhook-secret "new-secret" --force

# Then update in GitLab webhook settings
```

## Comparing GitHub vs GitLab

| Feature | GitHub | GitLab |
|---------|--------|--------|
| Webhook auth | HMAC-SHA256 signature | Token header |
| App model | GitHub App (auto-created) | OAuth (manual app creation) |
| Token storage | N/A (signature-based) | HMAC hashed |
| Multiple instances | No (github.com only) | Yes |

## Complete Example (OAuth Flow)

```bash
# 1. Register OAuth app (self-hosted only)
oore gitlab register \
  --instance https://gitlab.mycompany.com \
  --client-id YOUR_CLIENT_ID \
  --client-secret YOUR_CLIENT_SECRET

# 2. Run setup (opens browser automatically)
oore gitlab setup

# 3. List projects
oore gitlab projects

# 4. Enable CI for a project (creates repo + webhook automatically)
oore gitlab enable 12345678

# 5. Push code
git push origin main

# 6. Check builds
oore build list
```

## Manual Webhook Setup (Without OAuth)

If you prefer not to use OAuth:

<Steps>

1. **Add repository to Oore**

   ```bash
   oore repo add \
     --provider gitlab \
     --owner myuser \
     --repo my-project \
     --webhook-secret "my-secure-secret" \
     --gitlab-project-id 12345678
   ```

2. **Get webhook URL**

   ```bash
   oore repo webhook-url <repo-id>
   ```

3. **Configure in GitLab**

   Go to Settings → Webhooks in your GitLab project:

   | Field | Value |
   |-------|-------|
   | URL | Webhook URL from step 2 |
   | Secret token | Same secret from step 1 |
   | Push events | ✓ |
   | Merge request events | ✓ |

4. **Test the webhook**

   Click "Test" → "Push events" in GitLab, then verify:
   ```bash
   oore webhook list
   ```

</Steps>
