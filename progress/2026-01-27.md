# Progress Log - 2026-01-27

## Summary

Implemented fixes for issues identified in the Rust code review of the Oore CI/CD platform. All 7 tasks completed successfully.

## Completed Tasks

### 1. Added Documentation for Timing Assumption in `constant_time_eq`
- **File**: `crates/oore-core/src/crypto/mod.rs:65-79`
- Documented that the early return on length mismatch is acceptable because hex-encoded HMAC signatures always have fixed lengths (64 chars for SHA-256)

### 2. Improved Key Derivation with HKDF
- **Files**:
  - `Cargo.toml` - Added hkdf dependency
  - `crates/oore-core/Cargo.toml` - Added hkdf to workspace dependencies
  - `crates/oore-core/src/crypto/mod.rs:113-136`
- Replaced plain SHA-256 key derivation with HKDF-SHA256 (RFC 5869)
- Added domain separation via info parameter ("oore-encryption-key-v1")
- Documented security properties and limitations

### 3. Added Worker Task Supervision and Graceful Shutdown
- **Files**:
  - `crates/oore-server/src/worker/webhook_processor.rs:26-70`
  - `crates/oore-server/src/main.rs:124-168, 330-360`
- Created `WebhookWorkerHandle` with proper shutdown signaling
- Added `CleanupTaskHandle` for cleanup task supervision
- Worker and cleanup tasks now respond to shutdown signals via `watch` channel
- Server waits for background tasks to complete gracefully on shutdown
- Worker panics are now detected and logged

### 4. Handled Channel Backpressure Gracefully
- **File**: `crates/oore-server/src/routes/webhooks.rs:174-194, 326-346`
- Changed from silent warning to returning HTTP 503 when queue is full
- Response includes event_id so client knows the event was stored
- Events still stored in DB for recovery processing

### 5. Added Commit SHA Validation
- **File**: `crates/oore-server/src/worker/webhook_processor.rs:26-48, 261-272`
- Added `is_valid_commit_sha()` to validate SHA-1 (40 hex) and SHA-256 (64 hex) formats
- Added `format_commit_sha()` for safe display truncation
- Logs warning for invalid SHA formats but continues processing

### 6. Paginated Unprocessed Event Recovery
- **Files**:
  - `crates/oore-core/src/db/repository.rs:331-375`
  - `crates/oore-server/src/worker/webhook_processor.rs:73-150`
- Added `get_unprocessed_batch()` with LIMIT/OFFSET pagination
- Added `count_unprocessed()` for progress reporting
- Recovery now processes events in batches of 100
- Logs progress every 500 events for large recoveries

### 7. Added DateParse Error Variant for Better Error Context
- **Files**:
  - `crates/oore-core/src/error.rs:14-17`
  - `crates/oore-core/src/db/repository.rs:186-223, 368-396, 519-567`
- Added `OoreError::DateParse { field, message }` variant
- Updated all date parsing in repository.rs to use the new variant
- Errors now include field name for easier debugging

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| HKDF instead of Argon2 | Suitable for high-entropy env secrets; Argon2 is for passwords |
| 503 for queue backpressure | Client needs feedback; event is stored for recovery |
| Batch size of 100 | Balance between memory usage and DB round trips |
| Watch channel for shutdown | Allows multiple receivers and doesn't require ownership |

## Files Modified

| File | Changes |
|------|---------|
| `Cargo.toml` | Added hkdf dependency |
| `crates/oore-core/Cargo.toml` | Added hkdf to crate dependencies |
| `crates/oore-core/src/crypto/mod.rs` | HKDF key derivation, timing documentation |
| `crates/oore-core/src/error.rs` | DateParse error variant |
| `crates/oore-core/src/db/repository.rs` | Pagination, better error handling |
| `crates/oore-server/src/main.rs` | Graceful shutdown for workers |
| `crates/oore-server/src/worker/webhook_processor.rs` | Shutdown support, batched recovery, SHA validation |
| `crates/oore-server/src/routes/webhooks.rs` | 503 on backpressure |

## Warning Fixes (Additional)

Fixed all compiler and clippy warnings:

| Warning | Fix |
|---------|-----|
| `total_count` field never read | Added `#[allow(dead_code)]` - part of GitHub API response struct |
| `oauth_state` unused variable | Prefixed with `_` |
| `SERVICE_USER` constant unused | Added `#[allow(dead_code)]` - reserved for future dedicated user feature |
| `create_service_user` function unused | Added `#[allow(dead_code)]` - reserved for future use |
| `run_dscl`, `group_has_gid`, `create_user`, `find_available_id`, `chown_to_service_user`, `chgrp_to_service_user` unused | Added `#[allow(dead_code)]` - used by create_user, reserved for future |
| `is_finished` method unused | Added `#[allow(dead_code)]` - useful API method |
| `impl Default` can be derived | Used `#[derive(Default)]` with `#[default]` attribute on variant |
| `if` statement can be collapsed | Collapsed using let-chains (`if let Ok(out) = output && out.status.success()`) |
| useless `.into()` conversion | Removed redundant conversion |

## Verification

- All 24 tests pass
- Code compiles without errors
- Clippy passes with zero warnings

---

## Session 2: Second Code Review Fixes

A second comprehensive code review identified 17 additional issues. All critical and high-priority issues were fixed.

### Issues Fixed

#### Critical Security Fixes

**#1. GitLab Webhook HMAC Key Mismatch** (CRITICAL)
- **File**: `crates/oore-server/src/routes/gitlab_oauth.rs:998-1003`
- **Bug**: Webhook HMAC was computed using `base_url` instead of `server_pepper`
- **Impact**: Authentication bypass - any token would verify against wrong key
- **Fix**: Use `compute_gitlab_token_hmac` with correct `server_pepper`

**#3. DNS Rebinding SSRF Protection**
- **Files**:
  - `crates/oore-core/src/oauth/mod.rs` - Added `create_http_client_with_pinning()`
  - `crates/oore-core/src/oauth/gitlab.rs` - Updated all API methods
- **Risk**: Attacker could redirect self-hosted GitLab URL to internal IPs after validation
- **Fix**: Pin resolved IPs at validation time using reqwest's `resolve()` method

#### High Priority Fixes

**#2. Database Connection Pool Exhaustion**
- **File**: `crates/oore-core/src/db/mod.rs:15-36`
- Increased default from 5 to 20 connections
- Made configurable via `DATABASE_MAX_CONNECTIONS` env var

**#4. Worker Recovery Can Block Startup**
- **File**: `crates/oore-server/src/worker/webhook_processor.rs:100-155`
- Changed from blocking `send()` to non-blocking `try_send()` with retries
- Recovery now uses retry loop with delays to avoid blocking startup

**#5. OAuth State Race Condition**
- **Files**: `crates/oore-server/src/routes/webhooks.rs:166-185, 342-360`
- Added handling for SQLite unique constraint violations (code 2067)
- Returns `duplicate` status instead of error when race detected

**#6. JWT Validity Exceeds GitHub Limit**
- **File**: `crates/oore-core/src/oauth/github.rs:270-272`
- Reduced JWT validity from 10 minutes to 9 minutes
- Allows 1 minute clock skew margin (GitHub max is 10 minutes)

**#7. Missing Encryption Key Validation for GitLab**
- **File**: `crates/oore-server/src/main.rs:283-330`
- Server now validates encryption key against GitLab credentials at startup
- Prevents silent failures from changed encryption keys

**#8. Panic from `.expect()` in Production**
- **File**: `crates/oore-server/src/main.rs:340-355`
- Replaced `.expect()` with proper error handling for CORS origin parsing
- Invalid origins now log error and exit with code 1

**#9. URL Construction Without Proper Joining**
- **File**: `crates/oore-core/src/oauth/github.rs:46-50`
- Changed from string concatenation to `Url::join()`
- Handles edge cases like trailing slashes correctly

**#10. Unsafe Block Without SAFETY Comment**
- **File**: `crates/oore-server/src/service/mod.rs:147`
- Added required `// SAFETY:` comment for `libc::geteuid()`

**#11. Ineffective Worker Monitoring**
- **File**: `crates/oore-server/src/main.rs:396-412`
- Server now joins worker task on shutdown
- Detects and logs worker panics

**#12. DoS via Repository Pagination**
- **File**: `crates/oore-core/src/oauth/github.rs:391-458`
- Added configurable limit via `GITHUB_MAX_REPOS_PER_INSTALLATION` (default: 1000)
- Used `saturating_add` for page increment to prevent integer overflow (#14)

**#15. Missing GitLab Credentials Cleanup on Delete**
- **Files**:
  - `crates/oore-core/src/db/credentials.rs` - Added `deactivate_by_credential()`
  - `crates/oore-core/src/db/repository.rs` - Added `deactivate()`
  - `crates/oore-server/src/routes/gitlab_oauth.rs` - Updated `delete_credentials()`
- Deleting credentials now cascades: deactivates projects, removes webhooks (best effort), deactivates repositories

### Non-Issues (Verified Safe)

- **#13**: Webhook secrets already use 32 bytes (256 bits) of crypto randomness
- **#16**: HTTP client already has 30-second timeout configured

### Deferred

- **#17**: Metrics/Observability - enhancement, not a bug

### Documentation Updates

- **`docs/src/content/docs/configuration.mdx`**:
  - Added `DATABASE_MAX_CONNECTIONS` variable
  - Added `GITHUB_MAX_REPOS_PER_INSTALLATION` variable

- **`docs/src/content/docs/reference/api.mdx`**:
  - Added webhook endpoint response table (202, 200, 503, 401)
  - Added note about GitLab credential deletion cascade cleanup

- **`docs/src/content/docs/architecture.mdx`**:
  - Added SSRF protection table with DNS rebinding protection

## All Files Modified (Combined)

| File | Changes |
|------|---------|
| `Cargo.toml` | Added hkdf dependency |
| `.gitignore` | Added entries |
| `crates/oore-core/Cargo.toml` | Added hkdf |
| `crates/oore-core/src/crypto/mod.rs` | HKDF, timing docs |
| `crates/oore-core/src/db/credentials.rs` | `deactivate_by_credential()` |
| `crates/oore-core/src/db/mod.rs` | Configurable pool size |
| `crates/oore-core/src/db/repository.rs` | Pagination, `deactivate()`, DateParse errors |
| `crates/oore-core/src/error.rs` | DateParse variant |
| `crates/oore-core/src/oauth/github.rs` | JWT validity, URL joining, repo limit |
| `crates/oore-core/src/oauth/gitlab.rs` | DNS rebinding protection, pinned clients |
| `crates/oore-core/src/oauth/mod.rs` | `create_http_client_with_pinning()` |
| `crates/oore-server/src/cli.rs` | Warning fixes |
| `crates/oore-server/src/main.rs` | Graceful shutdown, GitLab validation, CORS error handling |
| `crates/oore-server/src/routes/gitlab_oauth.rs` | HMAC fix, cascade cleanup |
| `crates/oore-server/src/routes/oauth_callback.rs` | Minor fix |
| `crates/oore-server/src/routes/webhooks.rs` | Backpressure, race condition handling |
| `crates/oore-server/src/service/macos.rs` | Warning fixes |
| `crates/oore-server/src/service/mod.rs` | SAFETY comment |
| `crates/oore-server/src/worker/webhook_processor.rs` | Non-blocking recovery, SHA validation |
| `docs/src/content/docs/configuration.mdx` | New env vars |
| `docs/src/content/docs/reference/api.mdx` | Webhook responses, cascade note |
| `docs/src/content/docs/architecture.mdx` | SSRF protection section |

## Verification

- All 24 tests pass
- Zero clippy warnings
- Code compiles successfully

## Next Steps

Consider implementing:
- Rate limiting on webhook endpoints
- Metrics/observability (Prometheus metrics)
