# Progress Log - 2026-01-29

## Summary

Fixed GitLab repository listing bug in the Add Repository form and added automatic token refresh functionality. The form was failing to show any repositories due to API endpoint mismatches and missing response fields.

## Bug Fixes

### GitLab Project Listing Not Working

**Problem:** GitLab repositories weren't appearing in the Add Repository dropdown, even when repositories existed.

**Root Causes Found:**
1. **Wrong API endpoint** - Frontend called `/api/gitlab/credentials/{id}/projects` (non-existent), backend only had `/api/gitlab/projects?instance_url=...`
2. **Response type mismatch** - Frontend expected `{ projects: [...] }` wrapper, backend returned array directly
3. **Missing field** - Backend didn't return `default_branch` field needed for auto-populating the form

**Solution:**
- Fixed `useGitLabProjects` hook to use correct endpoint with `instance_url` query parameter
- Changed response type from `GitLabProjectsResponse` to `GitLabProject[]`
- Added `default_branch: Option<String>` to `GitLabProjectInfo` struct in Rust

## Features Added

### Automatic GitLab Token Refresh

**Problem:** When GitLab OAuth tokens expired, the Add Repository form showed "No projects found" with no indication of the real issue.

**Solution:** Added auto-refresh functionality:
- Detects when selected credential has `needs_refresh: true`
- Automatically calls refresh API before fetching projects
- Shows "Refreshing token..." message during refresh
- Toast notifications on success/failure
- Falls back to manual refresh in Settings if auto-refresh fails

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Fix frontend, not backend | Backend endpoint was correct; changing it would break CLI |
| Auto-refresh on selection | Better UX than requiring manual navigation to Settings |
| Toast notifications | Inform user of what's happening without blocking UI |

## Files Modified

| File | Changes |
|------|---------|
| `web/src/lib/api/gitlab.ts` | Fixed endpoint URL, response type, added `instanceUrl` param to `enableGitLabProject` |
| `web/src/lib/api/types.ts` | Made `default_branch` optional in `GitLabProject` interface |
| `web/src/app/(auth)/repositories/new/page.tsx` | Fixed hook usage, added auto-refresh logic, "Refreshing token..." UI |
| `crates/oore-core/src/oauth/gitlab.rs` | Added `default_branch` field to `GitLabProjectInfo` struct |
| `docs/src/content/docs/integrations/gitlab.mdx` | Added documentation about automatic token refresh |
| `web/src/app/(auth)/layout.tsx` | Increased SWR `dedupingInterval` to 2 minutes to reduce refetch spam |

## Commits

1. `fix(gitlab): correct project listing API integration` - API endpoint and response fixes
2. `feat(gitlab): auto-refresh expired tokens in Add Repository form` - Auto-refresh functionality

## CLI Status

Verified that the CLI (`oore`) was already using the correct API endpoints and didn't need fixes.

## SWR Refetch Optimization

**Problem:** Every page was refetching all SWR requests on every window refocus, causing excessive API calls and unnecessary network traffic.

**Root Cause:** Global SWRConfig had `dedupingInterval: 2000` (2 seconds), meaning after just 2 seconds, a window focus would trigger fresh fetches.

**Solution:** Increased `dedupingInterval` to `120000` (2 minutes) in the global SWRConfig. This prevents refetching on window focus if the same request was made within the last 2 minutes.

**Why not disable `revalidateOnFocus`?** Keeping focus-based revalidation enabled ensures data stays fresh when returning to the app after extended periods, while the 2-minute deduping window prevents the excessive refetching annoyance.

**File Modified:** `web/src/app/(auth)/layout.tsx` - Changed `dedupingInterval` from 2000 to 120000

## Next Steps

1. **Push commits** - 2 commits ready to push to origin/master
2. **Test edge cases** - Multiple GitLab instances, network failures during refresh
3. **Consider GitHub parity** - Check if GitHub integration needs similar token refresh handling

---

# Session 2: Build Pipeline Groundwork Implementation

## Summary

Implemented the build pipeline execution infrastructure for Oore. This enables Build records (created by webhooks) to actually execute Flutter builds using Codemagic-compatible YAML configuration.

## Features Added

### 1. Database Migration (004_pipeline_configs.sql)
- `pipeline_configs` table for UI-stored pipeline configurations
- `build_steps` table for tracking individual step execution
- `build_logs` table for log file metadata
- Extended `builds` table with `workflow_name`, `config_source`, `error_message`

### 2. Domain Models (oore-core/src/models/)
- `pipeline.rs` - ParsedPipeline, Workflow, Step, ConfigSource, etc.
- `build_step.rs` - BuildStep, StepStatus with lifecycle tracking
- `build_log.rs` - BuildLog, LogStream for stdout/stderr/system

### 3. Pipeline Parser (oore-core/src/pipeline/parser.rs)
- Parses Codemagic-compatible YAML using serde_yaml
- Validates required fields (workflows must have scripts)
- Warns about unsupported fields (cache, publishing, groups)

### 4. Config Resolver (oore-core/src/pipeline/resolver.rs)
- Resolves config from codemagic.yaml (takes precedence) or stored DB config
- Workflow selection by trigger event (push/pull_request) and branch patterns
- Glob pattern matching for branch include/exclude

### 5. Build Executor (oore-core/src/pipeline/executor.rs)
- `BuildExecutor` trait for future extensibility (containers, sandboxing)
- `ShellExecutor` implementation for direct host execution
- Git clone with partial clone (`--filter=blob:none`)
- Secure token injection for private repos
- Timeout and cancellation support
- Log streaming to files with size limits

### 6. Build Processor Worker (oore-server/src/worker/build_processor.rs)
- MPSC channel-based job queue (follows webhook_processor pattern)
- Concurrent build execution with configurable limits
- Cancellation via DashMap of watch channels
- Recovery of pending/running builds on startup

### 7. API Endpoints
- `GET /api/builds/{id}/steps` - Get build step execution details
- `GET /api/builds/{id}/logs` - Get log file metadata
- `GET /api/builds/{id}/logs/content` - Get actual log content
- `GET /api/repositories/{id}/pipeline` - Get stored pipeline config
- `PUT /api/repositories/{id}/pipeline` - Create/update pipeline config
- `DELETE /api/repositories/{id}/pipeline` - Delete pipeline config
- `POST /api/pipelines/validate` - Validate YAML without saving

### 8. CLI Commands
- `oore build steps <id>` - Display build steps
- `oore build logs <id> [--step N]` - Display build logs
- `oore pipeline show <repo_id>` - Show stored pipeline config
- `oore pipeline set <repo_id> --file <path>` - Upload pipeline config
- `oore pipeline delete <repo_id>` - Delete stored config
- `oore pipeline validate <file>` - Validate YAML file

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| File-based logs with DB index | Better for streaming, SQLite not ideal for large BLOBs |
| Fresh clone per build | Isolation and reproducibility, no cache invalidation complexity |
| Trait-based executor | Future flexibility for sandboxing/containerization |
| Codemagic YAML subset | Migration path for existing users, well-documented format |
| Strict branch exclusion | If workflow explicitly excludes branch, fail rather than fallback |

## Files Created

| File | Description |
|------|-------------|
| `crates/oore-core/migrations/004_pipeline_configs.sql` | Database migration |
| `crates/oore-core/src/models/pipeline.rs` | Pipeline domain models |
| `crates/oore-core/src/models/build_step.rs` | Build step model |
| `crates/oore-core/src/models/build_log.rs` | Build log model |
| `crates/oore-core/src/db/pipeline.rs` | Database repositories |
| `crates/oore-core/src/pipeline/mod.rs` | Pipeline module |
| `crates/oore-core/src/pipeline/parser.rs` | YAML parser |
| `crates/oore-core/src/pipeline/resolver.rs` | Config resolution |
| `crates/oore-core/src/pipeline/executor.rs` | Executor trait + ShellExecutor |
| `crates/oore-server/src/worker/build_processor.rs` | Build worker |
| `crates/oore-server/src/routes/pipelines.rs` | Pipeline API routes |
| `crates/oore-cli/src/commands/pipeline.rs` | Pipeline CLI |

## Files Modified

| File | Changes |
|------|---------|
| `Cargo.toml` | Added serde_yaml, glob, regex-lite, dashmap |
| `crates/oore-core/Cargo.toml` | Added new dependencies |
| `crates/oore-core/src/lib.rs` | Added pipeline module |
| `crates/oore-core/src/models/mod.rs` | Export new models |
| `crates/oore-core/src/models/build.rs` | Added workflow_name, config_source, error_message |
| `crates/oore-core/src/db/mod.rs` | Added pipeline module |
| `crates/oore-core/src/db/repository.rs` | Extended BuildRepo with new fields |
| `crates/oore-core/src/error.rs` | Added pipeline-related error variants |
| `crates/oore-server/Cargo.toml` | Added dashmap |
| `crates/oore-server/src/state.rs` | Added build_tx and cancel channels |
| `crates/oore-server/src/main.rs` | Start build processor, add routes |
| `crates/oore-server/src/worker/mod.rs` | Export build_processor |
| `crates/oore-server/src/worker/webhook_processor.rs` | Queue BuildJob after creating Build |
| `crates/oore-server/src/routes/mod.rs` | Added pipelines module |
| `crates/oore-server/src/routes/builds.rs` | Added logs/steps endpoints |
| `crates/oore-cli/src/main.rs` | Added Pipeline subcommand |
| `crates/oore-cli/src/commands/mod.rs` | Added pipeline module |
| `crates/oore-cli/src/commands/build.rs` | Added logs/steps subcommands |

## Testing

- All 158 tests pass (154 in oore-core + 4 in oored)
- Extensive unit tests added for all pipeline-related code
- Integration testing pending (requires actual git repos and build execution)

### Test Coverage Added

| Module | Tests Added | Coverage Areas |
|--------|-------------|----------------|
| `pipeline/parser.rs` | 22 tests | YAML parsing, validation, defaults, edge cases, multiline scripts, env vars |
| `pipeline/resolver.rs` | 25 tests | Workflow selection, branch patterns, trigger events, ambiguous workflows |
| `pipeline/executor.rs` | 18 tests | Token injection, error sanitization, limits, async step execution, cleanup |
| `models/pipeline.rs` | 29 tests | IDs, serde, config sources, trigger events, workflows, environments |
| `models/build_step.rs` | 17 tests | IDs, status lifecycle, serde, response DTOs |
| `models/build_log.rs` | 17 tests | IDs, log streams, serde, response DTOs |

### Concurrency Review (m07-concurrency skill)

Reviewed `build_processor.rs` and `executor.rs` for async/concurrency issues:

1. **Send/Sync compliance**: ✅ Uses `Arc<dyn BuildExecutor>`, `DashMap` for thread safety
2. **No MutexGuard across await**: ✅ No `Mutex`/`RwLock` used; `DashMap` handles internally
3. **Cancel channel pattern**: ✅ Uses `watch::channel` correctly; `borrow()` not held across await
4. **Semaphore usage**: ✅ Proper `tokio::sync::Semaphore` for concurrent build limits
5. **tokio::select! usage**: ✅ All branches return consistent types; handles timeout/cancellation/completion
6. **No blocking in async**: ✅ Uses `tokio::process::Command`, `tokio::fs`, `tokio::io`

## Known Limitations (For Future Work)

1. **No auth token minting** - Private repos need GitHub/GitLab token minting
2. **No web UI** - Pipeline editor and log viewer need frontend work
3. **No artifact collection** - Build artifacts not yet collected
4. **No notifications** - Slack/email/webhook notifications not implemented
5. **Runs as root** - Build scripts execute with server privileges

## Environment Variables Added

| Variable | Default | Description |
|----------|---------|-------------|
| `OORE_WORKSPACES_DIR` | `/var/lib/oore/workspaces` | Build workspace directory |
| `OORE_LOGS_DIR` | `/var/lib/oore/logs` | Build log directory |
| `OORE_MAX_BUILD_DURATION_SECS` | 3600 | Max build duration (1 hour) |
| `OORE_MAX_STEP_DURATION_SECS` | 1800 | Max step duration (30 min) |
| `OORE_MAX_LOG_SIZE_BYTES` | 52428800 | Max log file size (50MB) |
| `OORE_MAX_CONCURRENT_BUILDS` | 2 | Concurrent build limit |
| `OORE_WORKSPACE_RETENTION_HOURS` | 24 | Workspace retention time |
