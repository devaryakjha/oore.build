# Progress Log - 2026-01-29

## Summary

Fixed GitLab repository listing bug in the Add Repository form and added automatic token refresh functionality. The form was failing to show any repositories due to API endpoint mismatches and missing response fields.

## Bug Fixes

### GitLab Project Listing Not Working

**Problem:** GitLab repositories weren't appearing in the Add Repository dropdown, even when repositories existed.

**Root Causes Found:**
1. **Wrong API endpoint** - Frontend called `/api/gitlab/credentials/{id}/projects` (non-existent), backend only had `/api/gitlab/projects?instance_url=...`
2. **Response type mismatch** - Frontend expected `{ projects: [...] }` wrapper, backend returned array directly
3. **Missing field** - Backend didn't return `default_branch` field needed for auto-populating the form

**Solution:**
- Fixed `useGitLabProjects` hook to use correct endpoint with `instance_url` query parameter
- Changed response type from `GitLabProjectsResponse` to `GitLabProject[]`
- Added `default_branch: Option<String>` to `GitLabProjectInfo` struct in Rust

## Features Added

### Automatic GitLab Token Refresh

**Problem:** When GitLab OAuth tokens expired, the Add Repository form showed "No projects found" with no indication of the real issue.

**Solution:** Added auto-refresh functionality:
- Detects when selected credential has `needs_refresh: true`
- Automatically calls refresh API before fetching projects
- Shows "Refreshing token..." message during refresh
- Toast notifications on success/failure
- Falls back to manual refresh in Settings if auto-refresh fails

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Fix frontend, not backend | Backend endpoint was correct; changing it would break CLI |
| Auto-refresh on selection | Better UX than requiring manual navigation to Settings |
| Toast notifications | Inform user of what's happening without blocking UI |

## Files Modified

| File | Changes |
|------|---------|
| `web/src/lib/api/gitlab.ts` | Fixed endpoint URL, response type, added `instanceUrl` param to `enableGitLabProject` |
| `web/src/lib/api/types.ts` | Made `default_branch` optional in `GitLabProject` interface |
| `web/src/app/(auth)/repositories/new/page.tsx` | Fixed hook usage, added auto-refresh logic, "Refreshing token..." UI |
| `crates/oore-core/src/oauth/gitlab.rs` | Added `default_branch` field to `GitLabProjectInfo` struct |
| `docs/src/content/docs/integrations/gitlab.mdx` | Added documentation about automatic token refresh |
| `web/src/app/(auth)/layout.tsx` | Increased SWR `dedupingInterval` to 2 minutes to reduce refetch spam |

## Commits

1. `fix(gitlab): correct project listing API integration` - API endpoint and response fixes
2. `feat(gitlab): auto-refresh expired tokens in Add Repository form` - Auto-refresh functionality

## CLI Status

Verified that the CLI (`oore`) was already using the correct API endpoints and didn't need fixes.

## SWR Refetch Optimization

**Problem:** Every page was refetching all SWR requests on every window refocus, causing excessive API calls and unnecessary network traffic.

**Root Cause:** Global SWRConfig had `dedupingInterval: 2000` (2 seconds), meaning after just 2 seconds, a window focus would trigger fresh fetches.

**Solution:** Increased `dedupingInterval` to `120000` (2 minutes) in the global SWRConfig. This prevents refetching on window focus if the same request was made within the last 2 minutes.

**Why not disable `revalidateOnFocus`?** Keeping focus-based revalidation enabled ensures data stays fresh when returning to the app after extended periods, while the 2-minute deduping window prevents the excessive refetching annoyance.

**File Modified:** `web/src/app/(auth)/layout.tsx` - Changed `dedupingInterval` from 2000 to 120000

## Next Steps

1. **Push commits** - 2 commits ready to push to origin/master
2. **Test edge cases** - Multiple GitLab instances, network failures during refresh
3. **Consider GitHub parity** - Check if GitHub integration needs similar token refresh handling
