# Progress Log - 2026-01-29

## Summary

Fixed GitLab repository listing bug in the Add Repository form and added automatic token refresh functionality. The form was failing to show any repositories due to API endpoint mismatches and missing response fields.

## Bug Fixes

### GitLab Project Listing Not Working

**Problem:** GitLab repositories weren't appearing in the Add Repository dropdown, even when repositories existed.

**Root Causes Found:**
1. **Wrong API endpoint** - Frontend called `/api/gitlab/credentials/{id}/projects` (non-existent), backend only had `/api/gitlab/projects?instance_url=...`
2. **Response type mismatch** - Frontend expected `{ projects: [...] }` wrapper, backend returned array directly
3. **Missing field** - Backend didn't return `default_branch` field needed for auto-populating the form

**Solution:**
- Fixed `useGitLabProjects` hook to use correct endpoint with `instance_url` query parameter
- Changed response type from `GitLabProjectsResponse` to `GitLabProject[]`
- Added `default_branch: Option<String>` to `GitLabProjectInfo` struct in Rust

## Features Added

### Automatic GitLab Token Refresh

**Problem:** When GitLab OAuth tokens expired, the Add Repository form showed "No projects found" with no indication of the real issue.

**Solution:** Added auto-refresh functionality:
- Detects when selected credential has `needs_refresh: true`
- Automatically calls refresh API before fetching projects
- Shows "Refreshing token..." message during refresh
- Toast notifications on success/failure
- Falls back to manual refresh in Settings if auto-refresh fails

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| Fix frontend, not backend | Backend endpoint was correct; changing it would break CLI |
| Auto-refresh on selection | Better UX than requiring manual navigation to Settings |
| Toast notifications | Inform user of what's happening without blocking UI |

## Files Modified

| File | Changes |
|------|---------|
| `web/src/lib/api/gitlab.ts` | Fixed endpoint URL, response type, added `instanceUrl` param to `enableGitLabProject` |
| `web/src/lib/api/types.ts` | Made `default_branch` optional in `GitLabProject` interface |
| `web/src/app/(auth)/repositories/new/page.tsx` | Fixed hook usage, added auto-refresh logic, "Refreshing token..." UI |
| `crates/oore-core/src/oauth/gitlab.rs` | Added `default_branch` field to `GitLabProjectInfo` struct |
| `docs/src/content/docs/integrations/gitlab.mdx` | Added documentation about automatic token refresh |
| `web/src/app/(auth)/layout.tsx` | Increased SWR `dedupingInterval` to 2 minutes to reduce refetch spam |

## Commits

1. `fix(gitlab): correct project listing API integration` - API endpoint and response fixes
2. `feat(gitlab): auto-refresh expired tokens in Add Repository form` - Auto-refresh functionality

## CLI Status

Verified that the CLI (`oore`) was already using the correct API endpoints and didn't need fixes.

## SWR Refetch Optimization

**Problem:** Every page was refetching all SWR requests on every window refocus, causing excessive API calls and unnecessary network traffic.

**Root Cause:** Global SWRConfig had `dedupingInterval: 2000` (2 seconds), meaning after just 2 seconds, a window focus would trigger fresh fetches.

**Solution:** Increased `dedupingInterval` to `120000` (2 minutes) in the global SWRConfig. This prevents refetching on window focus if the same request was made within the last 2 minutes.

**Why not disable `revalidateOnFocus`?** Keeping focus-based revalidation enabled ensures data stays fresh when returning to the app after extended periods, while the 2-minute deduping window prevents the excessive refetching annoyance.

**File Modified:** `web/src/app/(auth)/layout.tsx` - Changed `dedupingInterval` from 2000 to 120000

## Next Steps

1. **Push commits** - 2 commits ready to push to origin/master
2. **Test edge cases** - Multiple GitLab instances, network failures during refresh
3. **Consider GitHub parity** - Check if GitHub integration needs similar token refresh handling

---

# Session 2: Build Pipeline Groundwork Implementation

## Summary

Implemented the build pipeline execution infrastructure for Oore. This enables Build records (created by webhooks) to actually execute Flutter builds using Codemagic-compatible YAML configuration.

## Features Added

### 1. Database Migration (004_pipeline_configs.sql)
- `pipeline_configs` table for UI-stored pipeline configurations
- `build_steps` table for tracking individual step execution
- `build_logs` table for log file metadata
- Extended `builds` table with `workflow_name`, `config_source`, `error_message`

### 2. Domain Models (oore-core/src/models/)
- `pipeline.rs` - ParsedPipeline, Workflow, Step, ConfigSource, etc.
- `build_step.rs` - BuildStep, StepStatus with lifecycle tracking
- `build_log.rs` - BuildLog, LogStream for stdout/stderr/system

### 3. Pipeline Parser (oore-core/src/pipeline/parser.rs)
- Parses Codemagic-compatible YAML using serde_yaml
- Validates required fields (workflows must have scripts)
- Warns about unsupported fields (cache, publishing, groups)

### 4. Config Resolver (oore-core/src/pipeline/resolver.rs)
- Resolves config from codemagic.yaml (takes precedence) or stored DB config
- Workflow selection by trigger event (push/pull_request) and branch patterns
- Glob pattern matching for branch include/exclude

### 5. Build Executor (oore-core/src/pipeline/executor.rs)
- `BuildExecutor` trait for future extensibility (containers, sandboxing)
- `ShellExecutor` implementation for direct host execution
- Git clone with partial clone (`--filter=blob:none`)
- Secure token injection for private repos
- Timeout and cancellation support
- Log streaming to files with size limits

### 6. Build Processor Worker (oore-server/src/worker/build_processor.rs)
- MPSC channel-based job queue (follows webhook_processor pattern)
- Concurrent build execution with configurable limits
- Cancellation via DashMap of watch channels
- Recovery of pending/running builds on startup

### 7. API Endpoints
- `GET /api/builds/{id}/steps` - Get build step execution details
- `GET /api/builds/{id}/logs` - Get log file metadata
- `GET /api/builds/{id}/logs/content` - Get actual log content
- `GET /api/repositories/{id}/pipeline` - Get stored pipeline config
- `PUT /api/repositories/{id}/pipeline` - Create/update pipeline config
- `DELETE /api/repositories/{id}/pipeline` - Delete pipeline config
- `POST /api/pipelines/validate` - Validate YAML without saving

### 8. CLI Commands
- `oore build steps <id>` - Display build steps
- `oore build logs <id> [--step N]` - Display build logs
- `oore pipeline show <repo_id>` - Show stored pipeline config
- `oore pipeline set <repo_id> --file <path>` - Upload pipeline config
- `oore pipeline delete <repo_id>` - Delete stored config
- `oore pipeline validate <file>` - Validate YAML file

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| File-based logs with DB index | Better for streaming, SQLite not ideal for large BLOBs |
| Fresh clone per build | Isolation and reproducibility, no cache invalidation complexity |
| Trait-based executor | Future flexibility for sandboxing/containerization |
| Codemagic YAML subset | Migration path for existing users, well-documented format |
| Strict branch exclusion | If workflow explicitly excludes branch, fail rather than fallback |

## Files Created

| File | Description |
|------|-------------|
| `crates/oore-core/migrations/004_pipeline_configs.sql` | Database migration |
| `crates/oore-core/src/models/pipeline.rs` | Pipeline domain models |
| `crates/oore-core/src/models/build_step.rs` | Build step model |
| `crates/oore-core/src/models/build_log.rs` | Build log model |
| `crates/oore-core/src/db/pipeline.rs` | Database repositories |
| `crates/oore-core/src/pipeline/mod.rs` | Pipeline module |
| `crates/oore-core/src/pipeline/parser.rs` | YAML parser |
| `crates/oore-core/src/pipeline/resolver.rs` | Config resolution |
| `crates/oore-core/src/pipeline/executor.rs` | Executor trait + ShellExecutor |
| `crates/oore-server/src/worker/build_processor.rs` | Build worker |
| `crates/oore-server/src/routes/pipelines.rs` | Pipeline API routes |
| `crates/oore-cli/src/commands/pipeline.rs` | Pipeline CLI |

## Files Modified

| File | Changes |
|------|---------|
| `Cargo.toml` | Added serde_yaml, glob, regex-lite, dashmap |
| `crates/oore-core/Cargo.toml` | Added new dependencies |
| `crates/oore-core/src/lib.rs` | Added pipeline module |
| `crates/oore-core/src/models/mod.rs` | Export new models |
| `crates/oore-core/src/models/build.rs` | Added workflow_name, config_source, error_message |
| `crates/oore-core/src/db/mod.rs` | Added pipeline module |
| `crates/oore-core/src/db/repository.rs` | Extended BuildRepo with new fields |
| `crates/oore-core/src/error.rs` | Added pipeline-related error variants |
| `crates/oore-server/Cargo.toml` | Added dashmap |
| `crates/oore-server/src/state.rs` | Added build_tx and cancel channels |
| `crates/oore-server/src/main.rs` | Start build processor, add routes |
| `crates/oore-server/src/worker/mod.rs` | Export build_processor |
| `crates/oore-server/src/worker/webhook_processor.rs` | Queue BuildJob after creating Build |
| `crates/oore-server/src/routes/mod.rs` | Added pipelines module |
| `crates/oore-server/src/routes/builds.rs` | Added logs/steps endpoints |
| `crates/oore-cli/src/main.rs` | Added Pipeline subcommand |
| `crates/oore-cli/src/commands/mod.rs` | Added pipeline module |
| `crates/oore-cli/src/commands/build.rs` | Added logs/steps subcommands |

## Testing

- All 158 tests pass (154 in oore-core + 4 in oored)
- Extensive unit tests added for all pipeline-related code
- Integration testing pending (requires actual git repos and build execution)

### Test Coverage Added

| Module | Tests Added | Coverage Areas |
|--------|-------------|----------------|
| `pipeline/parser.rs` | 22 tests | YAML parsing, validation, defaults, edge cases, multiline scripts, env vars |
| `pipeline/resolver.rs` | 25 tests | Workflow selection, branch patterns, trigger events, ambiguous workflows |
| `pipeline/executor.rs` | 18 tests | Token injection, error sanitization, limits, async step execution, cleanup |
| `models/pipeline.rs` | 29 tests | IDs, serde, config sources, trigger events, workflows, environments |
| `models/build_step.rs` | 17 tests | IDs, status lifecycle, serde, response DTOs |
| `models/build_log.rs` | 17 tests | IDs, log streams, serde, response DTOs |

### Concurrency Review (m07-concurrency skill)

Reviewed `build_processor.rs` and `executor.rs` for async/concurrency issues:

1. **Send/Sync compliance**: ✅ Uses `Arc<dyn BuildExecutor>`, `DashMap` for thread safety
2. **No MutexGuard across await**: ✅ No `Mutex`/`RwLock` used; `DashMap` handles internally
3. **Cancel channel pattern**: ✅ Uses `watch::channel` correctly; `borrow()` not held across await
4. **Semaphore usage**: ✅ Proper `tokio::sync::Semaphore` for concurrent build limits
5. **tokio::select! usage**: ✅ All branches return consistent types; handles timeout/cancellation/completion
6. **No blocking in async**: ✅ Uses `tokio::process::Command`, `tokio::fs`, `tokio::io`

## Known Limitations (For Future Work)

1. **No auth token minting** - Private repos need GitHub/GitLab token minting
2. **No web UI** - Pipeline editor and log viewer need frontend work
3. **No artifact collection** - Build artifacts not yet collected
4. **No notifications** - Slack/email/webhook notifications not implemented
5. **Runs as root** - Build scripts execute with server privileges

## Environment Variables Added

| Variable | Default | Description |
|----------|---------|-------------|
| `OORE_WORKSPACES_DIR` | `/var/lib/oore/workspaces` | Build workspace directory |
| `OORE_LOGS_DIR` | `/var/lib/oore/logs` | Build log directory |
| `OORE_MAX_BUILD_DURATION_SECS` | 3600 | Max build duration (1 hour) |
| `OORE_MAX_STEP_DURATION_SECS` | 1800 | Max step duration (30 min) |
| `OORE_MAX_LOG_SIZE_BYTES` | 52428800 | Max log file size (50MB) |
| `OORE_MAX_CONCURRENT_BUILDS` | 2 | Concurrent build limit |
| `OORE_WORKSPACE_RETENTION_HOURS` | 24 | Workspace retention time |

---

# Session 3: HUML Support for Pipeline Configuration

## Summary

Added HUML (Human Markup Language) support as an alternative configuration format for pipeline configs, alongside the existing YAML support. HUML is a stricter, simpler serialization format that avoids common YAML indentation footguns.

## Features Added

### Core Implementation
1. Added `huml-rs` dependency for HUML parsing
2. Created `ConfigFormat` enum (`Yaml`, `Huml`) in parser.rs
3. Implemented `parse_pipeline_huml()` function for HUML parsing
4. Implemented `parse_pipeline_auto()` for auto-detecting format from content
5. Updated resolver to check for all config file names in priority order:
   - `oore.huml` > `.oore.huml` > `oore.yaml` > `.oore.yaml` > `codemagic.huml` > `.codemagic.huml` > `codemagic.yaml` > `.codemagic.yaml` > database

### Database Changes
1. Created migration `005_pipeline_config_format.sql`:
   - Renamed `config_yaml` column to `config_content`
   - Added `config_format` column with CHECK constraint (`yaml` or `huml`)
2. Updated `PipelineConfig` model with new fields
3. Added `StoredConfigFormat` enum
4. Updated all database queries in `db/pipeline.rs`

### CLI Updates
1. Updated `oore pipeline` commands to support both formats
2. Added format auto-detection from file extension or content
3. Updated request/response DTOs to use `config_content` and `config_format`

### Server Updates
1. Updated `/api/repositories/:id/pipeline` endpoint to handle both formats
2. Updated `/api/pipelines/validate` endpoint to validate based on format

### Documentation
1. Created `docs/src/content/docs/guides/pipelines.mdx` - comprehensive pipeline configuration guide
2. Updated `docs/src/content/docs/reference/cli.mdx` - added pipeline commands section
3. Updated `CLAUDE.md` to reference new documentation

### Tests Added
17 new tests for HUML parsing:
- Minimal/full pipeline parsing
- Empty workflows/scripts validation
- Invalid syntax handling
- Multiple workflows
- Auto-detection tests
- ConfigFormat enum tests
- HUML-YAML equivalence tests

## HUML Syntax Notes

Key HUML syntax differences from YAML:
- Uses `::` for nested objects and arrays
- Strings must be quoted
- Arrays of objects use `- ::` syntax (not just `-`)
- Inline arrays: `items:: "a", "b", "c"`
- Files must start with `%HUML v0.2.0`

Example HUML pipeline:
```huml
%HUML v0.2.0
workflows::
  default::
    scripts::
      - ::
        script: "flutter build"
```

## Files Created

| File | Description |
|------|-------------|
| `crates/oore-core/migrations/005_pipeline_config_format.sql` | Database migration |
| `docs/src/content/docs/guides/pipelines.mdx` | Pipeline configuration guide |

## Files Modified

| File | Changes |
|------|---------|
| `crates/oore-core/Cargo.toml` | Added `huml-rs` dependency |
| `crates/oore-core/src/pipeline/parser.rs` | Added HUML parsing functions and 17 tests |
| `crates/oore-core/src/pipeline/resolver.rs` | Updated config file resolution |
| `crates/oore-core/src/models/pipeline.rs` | Added StoredConfigFormat, renamed fields, updated tests |
| `crates/oore-core/src/db/pipeline.rs` | Updated queries for new schema |
| `crates/oore-cli/src/commands/pipeline.rs` | Format auto-detection and updated DTOs |
| `crates/oore-server/src/routes/pipelines.rs` | Format-aware parsing |
| `docs/src/content/docs/reference/cli.mdx` | Added pipeline commands section |
| `CLAUDE.md` | Added HUML mention and pipelines.mdx reference |

## Test Results

All 181 tests pass (170 existing + 11 new HUML tests in parser.rs + updates to model tests)

---

# Session 4: CLI Profile-Based Configuration

## Summary

Implemented profile-based HUML configuration for the `oore` CLI, enabling multi-server workflows with `~/.oore/config.huml`. Moved the `init` command from CLI to the server (`oored init`) for creating server environment files.

## Features Added

### CLI Config System (`~/.oore/config.huml`)

New configuration file format using HUML:
```huml
%HUML v0.2.0
default_profile: "default"

profiles::
  default::
    server: "https://my-mac.local:8080"
    token: "abc123..."

  work::
    server: "https://ci.company.com:8080"
    token: "work-token..."
```

**Priority order** (highest to lowest):
1. CLI flags (`--server`, `--admin-token`)
2. Environment variables (`OORE_ADMIN_TOKEN`)
3. Config file profile
4. Hardcoded defaults (`http://localhost:8080`)

### New CLI Commands

- `oore config init` - Create a new config file
- `oore config set` - Update profile values (creates profile if it doesn't exist)
- `oore config show` - Display current configuration (with masked tokens)
- `oore config profiles` - List all available profiles
- `oore config path` - Show config file path

### Global CLI Options

- `--profile <NAME>` - Select which profile to use
- `--server <URL>` - Override server URL (overrides profile)
- `--admin-token <TOKEN>` - Override admin token (overrides profile and env)

### Server Init Command

Moved `init` from CLI to server binary:
- `oored init` - Initialize server environment file at `/etc/oore/oore.env`
- `--base-url` - Base URL for webhooks (default: `http://localhost:8080`)
- `--database-url` - Database URL (default: `sqlite:/var/lib/oore/oore.db`)
- `--force` - Regenerate all keys
- `--dry-run` - Preview without writing

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| HUML for config | Consistent with pipeline configs; stricter than YAML |
| Manual HUML serialization | huml-rs doesn't support serialization |
| 0600 file permissions | Secure tokens; warn if permissions too open |
| No config file = use defaults | Backwards compatible; no setup required |
| Separate server/CLI init | Server init needs root; CLI config is user-level |

## Files Created

| File | Description |
|------|-------------|
| `crates/oore-cli/src/config.rs` | Config loading and resolution (~200 lines) |
| `crates/oore-cli/src/commands/config.rs` | Config management commands (~350 lines) |
| `crates/oore-server/src/commands/mod.rs` | Commands module |
| `crates/oore-server/src/commands/init.rs` | Server init command (~230 lines) |

## Files Modified

| File | Changes |
|------|---------|
| `crates/oore-cli/Cargo.toml` | Added `huml-rs` and `dirs` dependencies |
| `crates/oore-cli/src/commands/mod.rs` | Added config module, removed init module |
| `crates/oore-cli/src/main.rs` | Added profile support, config resolution, Config command |
| `crates/oore-server/src/cli.rs` | Added Init command variant |
| `crates/oore-server/src/main.rs` | Added commands module, Init handler |
| `docs/src/content/docs/reference/cli.mdx` | Added config commands, profile docs, multi-server workflow |
| `CLAUDE.md` | Updated architecture, file locations, project status |

## Files Deleted

| File | Reason |
|------|--------|
| `crates/oore-cli/src/commands/init.rs` | Moved to server as `oored init` |

## Tests Added

12 new tests for config system:

**config.rs tests:**
- `test_default_config`
- `test_resolve_with_no_config`
- `test_resolve_with_config_file`
- `test_resolve_cli_flags_override`
- `test_resolve_profile_selection`
- `test_resolve_nonexistent_profile_error`
- `test_validate_empty_profiles`
- `test_validate_missing_default_profile`
- `test_validate_empty_server_url`

**commands/config.rs tests:**
- `test_mask_token_short`
- `test_mask_token_long`
- `test_serialize_to_huml`

## Usage Examples

```bash
# Initialize config
oore config init --server https://my-mac.local:8080

# Add a work profile
oore config set --profile work --server https://ci.company.com --token abc123

# Use profiles
oore --profile work repo list   # Uses work profile
oore repo list                  # Uses default profile

# Override for single command
oore --server https://temp.com health
```

## Test Results

All 12 new tests pass. Total: 193 tests passing (181 previous + 12 new).

---

# Session 5: Demo Mode Implementation

## Summary

Implemented a demo mode (`OORE_DEMO_MODE=true`) for local development and UI testing. When enabled, the server returns fake/simulated data for all API endpoints without requiring real GitHub/GitLab OAuth setup or database content.

## Features Added

### Core Demo Provider (oore-core/src/demo/)

Created a provider-based architecture for demo data:

1. **DemoProvider** - Central provider that generates and serves fake data
   - Singleton with pre-generated repositories and builds
   - Supports future scenario-based testing (error simulation)
   - Thread-safe with `Arc<Vec<T>>` for shared data

2. **Mock Data Generators** - Realistic fake data:
   - 12 repositories (7 GitHub, 5 GitLab) with varied configurations
   - 20+ builds with mixed statuses (success, failure, running, pending, cancelled)
   - 6 steps per build with appropriate status progressions
   - ANSI-colored log output for realistic terminal appearance
   - YAML and HUML pipeline configs for different repos

### API Integration

All relevant endpoints now check for demo mode first:
- `/api/setup/status` - Returns configured status for all integrations
- `/api/repositories` - Returns demo repositories
- `/api/repositories/:id` - Returns specific demo repo
- `/api/builds` - Returns demo builds
- `/api/builds/:id` - Returns specific demo build
- `/api/builds/:id/steps` - Returns demo build steps
- `/api/builds/:id/logs/content` - Returns ANSI-colored demo logs
- `/api/repositories/:id/pipeline` - Returns demo pipeline configs

### Setup Status in Demo Mode

When demo mode is enabled, all setup items show as configured:
- Encryption: configured
- Admin Token: configured
- GitHub: "Oore CI Demo" app with 3 installations
- GitLab: 2 instances (gitlab.com and enterprise)

### Frontend Integration

- Added `demo_mode: boolean` field to `SetupStatus` type
- "Demo Mode" badge displays in Setup Progress card when active

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| Provider pattern | Extensible for future scenarios (errors, edge cases) |
| Pre-generated data | Consistent IDs across requests; proper relationships |
| Check demo at route level | Clean separation; easy to bypass for specific routes |
| Real-looking data | Better testing of UI edge cases (long names, various statuses) |
| ANSI logs | Test log rendering without real builds |

## Files Created

| File | Description |
|------|-------------|
| `crates/oore-core/src/demo/mod.rs` | Demo module exports |
| `crates/oore-core/src/demo/data.rs` | Mock data generators (~700 lines) |
| `crates/oore-core/src/demo/provider.rs` | DemoProvider implementation (~150 lines) |

## Files Modified

| File | Changes |
|------|---------|
| `crates/oore-core/src/lib.rs` | Added `pub mod demo` |
| `crates/oore-server/src/state.rs` | Added `demo_provider: Option<Arc<DemoProvider>>` |
| `crates/oore-server/src/main.rs` | Check OORE_DEMO_MODE, create provider |
| `crates/oore-server/src/routes/setup.rs` | Return demo status when enabled |
| `crates/oore-server/src/routes/repositories.rs` | Demo mode for list/get |
| `crates/oore-server/src/routes/builds.rs` | Demo mode for all build endpoints |
| `crates/oore-server/src/routes/pipelines.rs` | Demo mode for get_pipeline_config |
| `web/src/lib/api/types.ts` | Added `demo_mode?: boolean` to SetupStatus |
| `web/src/components/dashboard/setup-status.tsx` | Demo Mode badge UI |
| `.env.example` | Documented OORE_DEMO_MODE |

## Demo Data Details

### Repositories (12 total)
- **GitHub (7)**: flutter-mobile-app, backend-api, shared-components, ios-native-module, android-sdk, design-system (inactive), docs-site
- **GitLab (5)**: enterprise-app, internal-tools, flutter-widgets, analytics-dashboard, ci-templates

### Builds
- Varied statuses: success, failure, running, pending, cancelled
- Different trigger types: push, pull_request, manual
- Multiple branches: main, develop, feature/new-ui, fix/login-bug, release/v1.2.0
- Error messages for failed builds

### Pipeline Configs
- Repos at index 0, 3, 6... get YAML config (Flutter CI)
- Repos at index 1, 4, 7... get HUML config (iOS Release)
- Repos at index 2, 5, 8... have no stored config

## Test Results

16 new tests added and passing:
- `test_github_status_is_configured`
- `test_gitlab_statuses_has_instances`
- `test_repositories_have_both_providers`
- `test_builds_have_various_statuses`
- `test_build_steps_generated`
- `test_log_content_has_ansi`
- `test_demo_provider_new`
- `test_list_repositories`
- `test_get_repository`
- `test_list_builds`
- `test_list_builds_by_repo`
- `test_list_build_steps`
- `test_get_build_log_content`
- `test_github_status_configured`
- `test_gitlab_statuses_configured`
- `test_pipeline_config`

Total: 209 tests passing (193 previous + 16 new).

## Usage

```bash
# Enable demo mode
export OORE_DEMO_MODE=true
cargo run -p oore-server

# Or in .env file
OORE_DEMO_MODE=true
```

## Next Steps

1. Test the full UI flow with demo mode enabled
2. Add demo data for GitHub/GitLab settings pages (installations, projects)
3. Consider adding simulated webhook events

---

# Session 6: Comprehensive Testing Infrastructure

## Summary

Implemented a complete testing infrastructure for Oore including API integration tests, CLI smoke tests, BDD specifications, and QA checklists. Documented 24 user journeys covering all CLI and Web UI scenarios.

## Features Added

### 1. Test Infrastructure Setup

Created test utilities framework for API integration testing:

- **Library crate exposure** - `crates/oore-server/src/lib.rs` exposes server components for integration tests
- **Test utilities module** - `crates/oore-server/src/test_utils.rs` provides:
  - `setup_test_db()` - Creates in-memory SQLite with migrations
  - `setup_test_state()` - Creates AppState for testing
  - `create_test_app_with_state()` - Returns app + config for full control
  - `TEST_ADMIN_TOKEN` constant for admin endpoint testing

### 2. API Integration Tests

Created `crates/oore-server/tests/api_tests.rs` with 24 tests covering:

| Module | Tests | Coverage |
|--------|-------|----------|
| health | 2 | GET /health, GET /api/health |
| repositories | 5 | List, get, not found, ULID validation, create |
| builds | 5 | List, get, not found, list by repo, filtering |
| pipelines | 4 | Validate YAML, invalid YAML, repo pipeline ops |
| admin_auth | 3 | Missing token, invalid token, valid token |
| webhooks | 2 | List events, GitHub status |
| setup | 3 | Status endpoint, encryption status, demo mode |

### 3. CLI Smoke Tests

Created `tests/cli/smoke_test.sh`:

- Tests all major CLI commands (health, repo, build, webhook, pipeline, config)
- Supports `--server`, `--token`, `--bin` arguments
- Colored output with pass/fail counts
- Graceful handling of expected failures

### 4. BDD Specifications

Created Gherkin-style test specifications in `tests/specs/`:

| File | Coverage |
|------|----------|
| `journey_01_first_time_setup.feature` | Server init, service install, CLI config |
| `journey_02_github_integration.feature` | GitHub App setup, installations, webhooks |
| `journey_06_build_execution.feature` | Webhook triggers, manual builds, states |

### 5. Documentation

Created comprehensive testing documentation:

| Document | Purpose |
|----------|---------|
| `documentation/TESTING.md` | Complete testing guide (~300 lines) |
| `documentation/user-journeys.md` | 24 user scenarios with paths and states |
| `documentation/qa-checklist.md` | 100+ manual test items organized by feature |
| `CONTRIBUTING.md` | Contribution guidelines with testing requirements |
| `docs/src/content/docs/guides/contributing.mdx` | Astro docs page for contributors |

### 6. Testing Pattern Enforcement

Updated `CLAUDE.md` with Rule #6:
```markdown
6. **Follow the testing pattern for new features** - Every new feature must include:
   - User journey documentation in `documentation/user-journeys.md`
   - API integration tests in `crates/oore-server/tests/api_tests.rs`
   - CLI smoke test cases in `tests/cli/smoke_test.sh`
   - BDD specifications in `tests/specs/` (for complex features)
   - QA checklist items in `documentation/qa-checklist.md`
```

## Key Technical Decisions

| Decision | Rationale |
|----------|-----------|
| axum-test v18 | Compatible with axum 0.8 (v16 was incompatible) |
| Feature flag for test-utils | `#[cfg(any(test, feature = "test-utils"))]` allows integration tests to access internals |
| In-memory SQLite per test | Isolation without cleanup; fresh state each test |
| Self-referential dev-dependency | `oore-server = { path = ".", features = ["test-utils"] }` enables feature in tests |

## Files Created

| File | Description |
|------|-------------|
| `crates/oore-server/src/lib.rs` | Library crate exposing server components |
| `crates/oore-server/src/test_utils.rs` | Test helpers (~150 lines) |
| `crates/oore-server/tests/api_tests.rs` | 24 integration tests (~400 lines) |
| `tests/cli/smoke_test.sh` | CLI smoke test script (~300 lines) |
| `tests/specs/journey_01_first_time_setup.feature` | BDD spec for setup |
| `tests/specs/journey_02_github_integration.feature` | BDD spec for GitHub |
| `tests/specs/journey_06_build_execution.feature` | BDD spec for builds |
| `documentation/TESTING.md` | Testing guide |
| `documentation/user-journeys.md` | User scenarios |
| `documentation/qa-checklist.md` | Manual QA checklist |
| `CONTRIBUTING.md` | Contribution guidelines |
| `docs/src/content/docs/guides/contributing.mdx` | Docs site contributing page |

## Files Modified

| File | Changes |
|------|---------|
| `Cargo.toml` | Added axum-test, temp-env, tempfile to workspace |
| `crates/oore-server/Cargo.toml` | Added lib section, test-utils feature, dev-deps |
| `CLAUDE.md` | Added testing rule, internal docs section, updated architecture |
| `docs/astro.config.mjs` | Added Contributing to sidebar |

## Errors Encountered and Fixed

| Error | Fix |
|-------|-----|
| axum-test v16 incompatible with axum 0.8 | Updated to axum-test v18 |
| test_utils not visible to integration tests | Changed to `#[cfg(any(test, feature = "test-utils"))]` + feature flag |
| Invalid ULID returns 400 not 404 | Used valid ULID format in tests |
| Invalid pipeline YAML returns 400 | Changed test assertion to expect 400 |
| GitHub app not configured returns 200 | Test checks `configured: false` field |

## Test Results

All 24 API integration tests pass:
```
test health::api_health ... ok
test health::root_health ... ok
test repositories::list_empty ... ok
test repositories::get_not_found ... ok
test repositories::invalid_ulid_returns_400 ... ok
test repositories::create_repository ... ok
test repositories::get_by_id ... ok
test builds::list_empty ... ok
test builds::get_not_found ... ok
test builds::list_by_repository ... ok
test builds::filter_by_status ... ok
test builds::filter_by_branch ... ok
test pipelines::validate_pipeline ... ok
test pipelines::validate_invalid_pipeline ... ok
test pipelines::get_pipeline_for_repo ... ok
test pipelines::set_pipeline_for_repo ... ok
test admin_auth::missing_token ... ok
test admin_auth::invalid_token ... ok
test admin_auth::valid_token ... ok
test webhooks::list_events_empty ... ok
test webhooks::github_status_unconfigured ... ok
test setup::status_endpoint ... ok
test setup::encryption_configured ... ok
test setup::demo_mode_disabled ... ok
```

Total: 233 tests passing (209 previous + 24 new).

## Directory Structure

```
oore.build/
├── documentation/           # Internal development docs (NEW)
│   ├── TESTING.md          # Complete testing guide
│   ├── user-journeys.md    # User scenarios
│   └── qa-checklist.md     # Manual QA items
│
├── tests/
│   ├── cli/
│   │   └── smoke_test.sh   # CLI smoke tests (NEW)
│   └── specs/              # BDD specifications (NEW)
│       ├── journey_01_first_time_setup.feature
│       ├── journey_02_github_integration.feature
│       └── journey_06_build_execution.feature
│
├── crates/oore-server/
│   ├── src/
│   │   ├── lib.rs          # Library crate (NEW)
│   │   └── test_utils.rs   # Test helpers (NEW)
│   └── tests/
│       └── api_tests.rs    # Integration tests (NEW)
│
├── docs/src/content/docs/
│   └── guides/
│       └── contributing.mdx # Public contributing guide (NEW)
│
├── CONTRIBUTING.md          # Root contribution guidelines (NEW)
└── CLAUDE.md               # Updated with testing rules
```

## Next Steps

1. Add more BDD specs for remaining journeys (3-5, 7-24)
2. Implement BDD test runner (cucumber-rs or custom)
3. Add CI/CD workflow for automated testing
4. Increase API test coverage for error paths
5. Add web UI component tests (React Testing Library)
