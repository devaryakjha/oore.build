# Progress: 2026-01-24

## Summary

Implemented the complete Git integration system for GitHub and GitLab webhooks as specified in the plan. This is a major milestone that adds the foundational webhook infrastructure for the CI/CD platform.

## Key Decisions Made

1. **HMAC storage for GitLab tokens**: Chose HMAC-SHA256 with server pepper instead of plain text storage for webhook tokens. This provides security without the overhead of password hashing algorithms like Argon2.

2. **ULID for IDs**: Using ULIDs for all entity IDs (repositories, builds, webhook events) provides sortable, unique identifiers.

3. **Async webhook processing**: Webhooks are stored immediately and processed asynchronously via a background worker with in-process channel queue. This ensures fast response times (<10s as required by GitHub).

4. **Environment-based GitHub App config**: GitHub App credentials come from environment variables rather than database storage, simplifying the MVP.

5. **AES-256-GCM for encryption**: Using AES-256-GCM for encrypting sensitive tokens (like GitLab access tokens). Key is derived from an environment variable.

## Important Findings

- GitHub requires webhook responses within 10 seconds, necessitating async processing
- GitHub uses HMAC-SHA256 for signature verification (`sha256=<hex>` format)
- GitLab uses a simple token header (`X-Gitlab-Token`) that we HMAC before storage
- SQLx migrations run automatically on startup with WAL mode enabled

## Files Created

### oore-core (core library)
- `migrations/001_initial_schema.sql` - Database schema
- `src/error.rs` - Error types
- `src/crypto/mod.rs` - HMAC, AES encryption, signature verification
- `src/db/mod.rs` - Database pool creation and migrations
- `src/db/repository.rs` - CRUD operations for repositories, webhook events, builds
- `src/models/mod.rs`, `provider.rs`, `repository.rs`, `webhook.rs`, `build.rs` - Domain models
- `src/webhook/mod.rs`, `verifier.rs`, `parser.rs` - Webhook verification and parsing
- `src/providers/mod.rs`, `github.rs`, `gitlab.rs` - Provider configurations

### oore-server
- `src/state.rs` - Application state with DB pool, config, provider configs
- `src/routes/mod.rs`, `webhooks.rs`, `repositories.rs`, `builds.rs` - HTTP endpoints
- `src/worker/mod.rs`, `webhook_processor.rs` - Background webhook processor

### oore-cli
- `src/commands/mod.rs`, `repo.rs`, `webhook.rs`, `build.rs` - CLI commands

### Configuration
- `.env.example` - Environment variable documentation

## Files Modified

- `Cargo.toml` - Added workspace dependencies (crypto, ulid, chrono, etc.)
- `crates/oore-core/Cargo.toml` - Added new dependencies
- `crates/oore-server/Cargo.toml` - Added new dependencies
- `crates/oore-cli/Cargo.toml` - Added chrono dependency
- `crates/oore-core/src/lib.rs` - Module exports
- `crates/oore-server/src/main.rs` - Full server implementation with routes, state, worker
- `crates/oore-cli/src/main.rs` - Added repo, webhook, build commands

## API Endpoints Implemented

### Webhooks
- `POST /api/webhooks/github` - Receive GitHub webhooks
- `POST /api/webhooks/gitlab/:repo_id` - Receive GitLab webhooks
- `GET /api/webhooks/events` - List webhook events
- `GET /api/webhooks/events/:id` - Get webhook event details

### Repositories
- `GET /api/repositories` - List repositories
- `POST /api/repositories` - Create repository
- `GET /api/repositories/:id` - Get repository
- `PUT /api/repositories/:id` - Update repository
- `DELETE /api/repositories/:id` - Delete repository
- `GET /api/repositories/:id/webhook-url` - Get webhook URL for provider setup

### Builds
- `GET /api/builds` - List builds
- `GET /api/builds/:id` - Get build details
- `POST /api/builds/:id/cancel` - Cancel a build
- `POST /api/repositories/:id/trigger` - Trigger manual build

## CLI Commands Implemented

```
oore repo list                              # List repositories
oore repo add --provider <p> --owner <o> --repo <r>  # Add repository
oore repo show <id>                         # Show repository
oore repo remove <id>                       # Remove repository
oore repo webhook-url <id>                  # Get webhook URL

oore webhook list                           # List webhook events
oore webhook show <id>                      # Show webhook event

oore build list [--repo <id>]               # List builds
oore build show <id>                        # Show build
oore build trigger <repo_id> [--branch <b>] # Trigger manual build
oore build cancel <id>                      # Cancel build
```

## Tests

9 tests implemented and passing:
- Crypto: GitHub signature verification, GitLab token verification, AES encryption roundtrip
- Webhook parser: GitHub push, GitHub PR, GitLab push, GitLab MR
- Webhook verifier: GitHub verifier, GitLab verifier

## Next Steps

1. **Build Execution**: Actually run builds (clone, execute pipeline, report status)
2. **GitHub App Token Minting**: Generate installation tokens using JWT + private key
3. **Status Reporting**: Report build status back to GitHub/GitLab
4. **Pipeline Configuration**: YAML-based pipeline definition (oore.yaml)
5. **Authentication**: Add admin token or localhost-only restriction for management endpoints
6. **Web Dashboard**: Connect Next.js frontend to these APIs
