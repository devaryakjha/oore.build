# Progress: 2026-01-25

## Summary

Implemented service management for the `oored` daemon. Users can now easily install, control, and monitor the Oore server as a system service without manually configuring launchd/systemd.

## Key Decisions Made

### 1. Service runs as root (not a dedicated user)

**Decision**: Run the daemon as root instead of creating a dedicated `oore` user.

**Why**: After extensive research and debugging:
- Initial implementation attempted to create an `oore` system user via `dscl` on macOS
- This caused issues: GID conflicts (400 already used by Apple), broken group records, `chown` failures
- Researched how other tools handle this:
  - **cloudflared**: Runs as root. Issue #672 suggested a dedicated user but was never implemented
  - **Homebrew services**: `sudo brew services start` runs daemons as root
  - **Apple's guidance**: System daemons should be owned by root:wheel
- Running as root is the industry-standard approach for system daemons
- A dedicated user can be added later if needed (noted in plist comment)

### 2. System service (not user service)

**Decision**: Install as a LaunchDaemon (macOS) / systemd system unit (Linux).

**Why**: A CI/CD server should:
- Start at boot, even without user login
- Run continuously in the background
- Have system-level permissions for build operations

### 3. Environment file approach

**Decision**: Use `OORE_ENV_FILE` environment variable pointing to `/etc/oore/oore.env`.

**Why**:
- Separates configuration from code
- Secure: env file is chmod 600 (readable only by root)
- Easy to update: edit one file, restart service
- DATABASE_URL is automatically rewritten to absolute path during install

### 4. Log rotation

**Decision**: Configure automatic log rotation (newsyslog on macOS, logrotate on Linux).

**Why**:
- Logs are written to `/var/log/oore/oored.log`
- Without rotation, logs would grow unbounded
- 14-day retention with compression

### 5. Backward compatibility

**Decision**: Running `oored` with no arguments defaults to `oored run`.

**Why**: Existing usage and development workflows continue to work unchanged.

### 6. Graceful shutdown

**Decision**: Handle SIGTERM/SIGINT for clean server shutdown.

**Why**:
- launchd/systemd send SIGTERM when stopping services
- Allows in-flight requests to complete
- Prevents data corruption

## Files Created

### oore-server
- `src/cli.rs` - CLI argument parsing with clap
- `src/service/mod.rs` - Platform detection, common operations, ServicePaths/ServiceStatus structs
- `src/service/macos.rs` - macOS launchd implementation (plist, launchctl, newsyslog)
- `src/service/linux.rs` - Linux systemd implementation (unit file, systemctl, logrotate)

## Files Modified

- `crates/oore-server/Cargo.toml` - Added clap, anyhow, and libc dependencies
- `crates/oore-server/src/main.rs` - CLI routing, graceful shutdown, OORE_ENV_FILE support

## Commands Implemented

```
oored run        # Run server in foreground (default)
oored install    # Install as system service (requires sudo)
oored uninstall  # Remove system service (--purge to remove data)
oored start      # Start the service
oored stop       # Stop the service
oored restart    # Restart the service
oored status     # Show service status
oored logs       # View logs (-n lines, -f follow)
```

## File Locations (when installed)

| Item | macOS | Linux |
|------|-------|-------|
| Service file | `/Library/LaunchDaemons/build.oore.oored.plist` | `/etc/systemd/system/oored.service` |
| Binary | `/usr/local/bin/oored` | `/usr/local/bin/oored` |
| Data | `/var/lib/oore/` | `/var/lib/oore/` |
| Logs | `/var/log/oore/oored.log` | `/var/log/oore/oored.log` |
| Config | `/etc/oore/oore.env` | `/etc/oore/oore.env` |
| Log rotation | `/etc/newsyslog.d/oore.conf` | `/etc/logrotate.d/oore` |

## Service Features

- Runs at boot automatically (RunAtLoad / WantedBy=multi-user.target)
- Auto-restarts on crash (KeepAlive on macOS, Restart=always on Linux)
- High file descriptor limits (65536)
- Log rotation (14 days retention, compressed)
- Graceful shutdown handling
- Security hardening on Linux (NoNewPrivileges, ProtectSystem, etc.)

## Usage Example

```bash
# Build release binary
cargo build --release -p oore-server

# Install as system service (requires sudo)
sudo ./target/release/oored install

# Configure
sudo nano /etc/oore/oore.env

# Start service
sudo oored start

# Check status
oored status

# View logs (follow mode)
oored logs -f

# Uninstall (preserve data)
sudo oored uninstall

# Uninstall completely
sudo oored uninstall --purge
```

## Issues Encountered and Resolved

### Issue 1: macOS user/group creation failures
- `chown: oore: illegal group name` - Group created but without PrimaryGroupID
- GID 400 conflict with `com.apple.access_remote_ae`
- **Resolution**: Removed dedicated user creation; run as root like cloudflared

### Issue 2: Service start hanging
- `launchctl` commands blocking or silently failing
- **Resolution**: Changed from `.output()` to `.status()`, added proper error handling

### Issue 3: Relative DATABASE_URL
- `.env` file had `DATABASE_URL=sqlite:oore.db` (relative path)
- Service runs from `/var/lib/oore`, couldn't find DB
- **Resolution**: `setup_env_file()` rewrites DATABASE_URL to absolute path

---

## Session 2: Marketing Landing Page

### Summary

Implemented the marketing landing page for oore.build at `/landing/`. The site is built with Astro and Tailwind CSS v4, designed for deployment on Cloudflare Pages.

### What Was Done

#### Project Setup
- Created `/landing/` directory with Astro project structure
- Configured Tailwind CSS v4 via `@tailwindcss/vite` (not the legacy @astrojs/tailwind integration)
- Set up TypeScript with strict mode
- Reused color tokens from the existing `web/` dashboard for brand consistency

#### Components Created
- **Layout.astro**: Base layout with SEO meta tags, OG tags, Twitter cards
- **Hero.astro**: Headline, description, GitHub star CTA, terminal preview
- **Features.astro**: 6 capability cards with icons
- **WhySelfHost.astro**: Problem statement + 3 factual points
- **QuickStart.astro**: Installation commands in terminal style
- **Status.astro**: Project status (implemented vs in-progress)
- **Footer.astro**: Links and author attribution
- **ui/Card.astro**: Glassmorphism card component
- **ui/Terminal.astro**: Terminal-style code display with title bar

#### Static Assets
- `favicon.svg`: Simple ring logo
- `og-image.svg`: Social share image template (needs PNG conversion)
- `robots.txt`: Search engine directives
- `_headers`: Security headers for Cloudflare

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Tailwind v4 via Vite plugin | The @astrojs/tailwind integration is for v3; v4 requires @tailwindcss/vite |
| SVG favicon | Smaller file size, scales perfectly, modern browser support |
| No web fonts | Faster load times, uses system fonts |
| Single CTA | Open-source project doesn't need multiple sales CTAs |
| Documentation tone | Technical, factual - not marketing hype |

### Files Created

- `landing/package.json`
- `landing/astro.config.mjs`
- `landing/tsconfig.json`
- `landing/.gitignore`
- `landing/README.md`
- `landing/src/layouts/Layout.astro`
- `landing/src/pages/index.astro`
- `landing/src/styles/global.css`
- `landing/src/components/Hero.astro`
- `landing/src/components/Features.astro`
- `landing/src/components/WhySelfHost.astro`
- `landing/src/components/QuickStart.astro`
- `landing/src/components/Status.astro`
- `landing/src/components/Footer.astro`
- `landing/src/components/ui/Card.astro`
- `landing/src/components/ui/Terminal.astro`
- `landing/public/favicon.svg`
- `landing/public/og-image.svg`
- `landing/public/robots.txt`
- `landing/public/_headers`

### Verification

- [x] `bun install` - Dependencies installed successfully
- [x] `bun run build` - Builds without errors (0 errors, 0 warnings)
- [x] `bun run dev` - Dev server runs at localhost:4321
- [x] HTTP 200 response on homepage

---

## Session 3: Documentation Site with Starlight

### Summary

Replaced the plain markdown documentation with a full Astro Starlight documentation site. The docs site matches the landing page styling (colors, buttons, cards) and is deployed to https://docs.oore.build.

### What Was Done

#### Initial Exploration
- User initially suggested Mintlify, but discovered it's a SaaS product requiring their dashboard
- Researched alternatives: Starlight (Astro's official docs framework) chosen for being fully open source and Astro-based (good for Cloudflare deployment)

#### Starlight Setup
- Created new Astro project with Starlight integration in `/docs/`
- Migrated all existing markdown documentation to MDX format with Starlight components
- Configured sidebar navigation with logical groupings

#### Custom Theming to Match Landing Page
- **Colors**: Amber/orange accent (`oklch(0.77 0.16 70)` / `#f49f1e`), dark background (`oklch(0.145 0 0)`)
- **Buttons**: Squircle shape (`0.625rem` radius), icons on left, white primary / bordered secondary
- **Cards**: Glass effect with backdrop blur and subtle borders
- **Code blocks**: Rounded corners on outer frame, consistent border styling
- **Hero gradient**: Full-viewport radial gradient matching landing page

#### Logo Assets
- Created `logo-dark.svg` and `logo-light.svg` with the split O design
- Configured automatic light/dark mode switching in header and hero

#### Landing Page Updates
- Updated all documentation links to point to https://docs.oore.build
- Fixed GitHub URLs from `oore` to `oore.build` repo

#### Makefile Targets
- Added `docs`, `docs-dev`, `docs-deploy` targets
- Changed `npx` to `bunx` for consistency with bun usage

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Starlight over Mintlify | Mintlify is SaaS requiring their dashboard; Starlight is fully open source |
| Match landing page styling exactly | Brand consistency across landing and docs sites |
| No Tailwind in docs | Starlight has complex Tailwind v4 integration; pure CSS variables simpler |
| Button icons on left | Matches landing page button style |
| Fixed viewport gradient | Landing page gradient spans viewport, not constrained to container |

### Files Created

**Configuration:**
- `docs/package.json`
- `docs/astro.config.mjs`
- `docs/tsconfig.json`
- `docs/.gitignore`
- `docs/src/content.config.ts`

**Assets:**
- `docs/src/assets/logo-dark.svg`
- `docs/src/assets/logo-light.svg`
- `docs/public/favicon.svg`

**Styling:**
- `docs/src/styles/custom.css` - Full custom theme (272 lines)

**Documentation (MDX):**
- `docs/src/content/docs/index.mdx` - Splash/hero page
- `docs/src/content/docs/introduction.mdx`
- `docs/src/content/docs/quickstart.mdx`
- `docs/src/content/docs/architecture.mdx`
- `docs/src/content/docs/configuration.mdx`
- `docs/src/content/docs/guides/service-management.mdx`
- `docs/src/content/docs/integrations/github.mdx`
- `docs/src/content/docs/integrations/gitlab.mdx`
- `docs/src/content/docs/reference/cli.mdx`
- `docs/src/content/docs/reference/api.mdx`

### Files Modified

- `landing/src/components/Footer.astro` - Updated docs link
- `landing/src/components/QuickStart.astro` - Updated docs link
- `landing/src/components/Hero.astro` - Fixed GitHub URL, formatting
- `landing/src/components/Status.astro` - Fixed GitHub URL, formatting
- `landing/package.json` - Dependency updates
- `Makefile` - Added docs targets

### Issues Encountered and Resolved

#### Issue 1: Tailwind CSS v4 build errors
- Initial attempt included Tailwind via `@astrojs/starlight-tailwind`
- Build failed with `Invalid declaration` errors
- **Resolution**: Removed Tailwind entirely, used only Starlight CSS variables

#### Issue 2: Code block header/body radius mismatch
- Border radius on `pre` element but not on header created visual break
- **Resolution**: Applied radius to outer `.expressive-code figure.frame` with `overflow: hidden`

#### Issue 3: Hero gradient constrained to container
- Gradient appeared as visible rectangle instead of viewport-spanning effect
- **Resolution**: Changed from `.hero::before` to `.main-pane::before` with `position: fixed`

### Commits

- `aa5884f` - feat: replace markdown docs with Starlight documentation site
- `86cffe2` - chore: add docs Makefile targets and update dependencies

### Deployment

- Landing page: https://oore.build (Cloudflare Pages)
- Documentation: https://docs.oore.build (Cloudflare Pages)

---

## Session 4: Documentation Audit and Synchronization

### Summary

Comprehensive audit of all documentation comparing against actual codebase implementation. Found and fixed 43+ discrepancies between documentation and code.

### What Was Done

#### Documentation Analysis
- Compared environment variables in `state.rs`, `providers/github.rs`, `providers/gitlab.rs` against `configuration.mdx`
- Verified CLI commands in `commands/github.rs`, `commands/gitlab.rs` against `reference/cli.mdx`
- Verified API endpoints in `routes/github_oauth.rs`, `routes/gitlab_oauth.rs`, `routes/repositories.rs` against `reference/api.mdx`
- Checked architecture structure against actual crate layout

#### Critical Fixes in `configuration.mdx`
| Old (Wrong) | New (Correct) | Impact |
|-------------|---------------|--------|
| `HOST`/`PORT` configurable | Documented as hardcoded | Prevents confusion |
| `BASE_URL` | `OORE_BASE_URL` | Would break config |
| `DASHBOARD_ORIGIN` | `OORE_DASHBOARD_ORIGIN` | Would break CORS |
| `GITHUB_APP_PRIVATE_KEY` (content) | `GITHUB_PRIVATE_KEY_PATH` (file path) | **Critical**: Would completely break GitHub setup |
| `GITLAB_TOKEN` exists | Removed (unused) | Avoids confusion |

Added missing variables:
- `OORE_DEV_MODE`, `GITLAB_SERVER_PEPPER`, `GITLAB_API_BASE_URL`
- GitLab OAuth: `OORE_GITLAB_CLIENT_ID`, `OORE_GITLAB_CLIENT_SECRET`
- Self-hosted security: `OORE_GITLAB_ALLOWED_HOSTS`, `OORE_GITLAB_CA_BUNDLE`, etc.

#### API Reference (`reference/api.mdx`)
Added missing endpoints:
- `PUT /api/repositories/:id` (update)
- GitHub: `/manifest`, `/app`, `DELETE /app`, `/sync`
- GitLab: All OAuth endpoints (`/connect`, `/callback`, `/credentials`, `/projects`, `/enabled`, `/refresh`, `/apps`)

Fixed HTTP methods:
- `POST /api/gitlab/connect` (was GET)
- `POST /api/gitlab/callback` (was GET)

#### CLI Reference (`reference/cli.mdx`)
Added 15+ missing commands:
- `oore github callback`, `installations`, `sync`, `remove`
- `oore gitlab callback`, `projects`, `enable`, `disable`, `refresh`, `register`, `remove`
- Documented all command options and parameters

#### Integration Docs
- **GitHub**: Fixed private key to use file path, added secure file handling instructions
- **GitLab**: Complete rewrite of OAuth section for gitlab.com and self-hosted instances

#### CLAUDE.md
- Updated documentation paths to Starlight MDX locations
- Fixed architecture diagram (added `oauth/` module, corrected migrations path)
- Updated project status with implemented features

### Key Findings

| Category | Count | Severity |
|----------|-------|----------|
| Environment variable name mismatches | 2 | Critical |
| Undocumented environment variables | 13 | High |
| Missing API endpoints | 13 | High |
| Missing CLI commands | 15+ | High |
| Architecture module undocumented | 1 (`oauth/`) | Medium |
| GitHub config example was wrong | 1 | Critical |

### Files Modified

- `docs/src/content/docs/configuration.mdx`
- `docs/src/content/docs/reference/api.mdx`
- `docs/src/content/docs/reference/cli.mdx`
- `docs/src/content/docs/integrations/github.mdx`
- `docs/src/content/docs/integrations/gitlab.mdx`
- `CLAUDE.md`

---

## Next Steps

1. **Build Execution**: Actually run builds (clone, execute pipeline, report status)
2. **GitHub App Token Minting**: Generate installation tokens using JWT + private key
3. **Status Reporting**: Report build status back to GitHub/GitLab
4. **Pipeline Configuration**: YAML-based pipeline definition (oore.yaml)
5. **Web Dashboard**: Connect Next.js frontend to these APIs
6. **Consider making HOST/PORT configurable**: Currently hardcoded to `0.0.0.0:8080`
