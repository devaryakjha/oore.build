# Progress: 2026-01-30

## Summary

Improved build UX with major features and critical bug fixes:
1. **System Steps Visibility** - Clone and Cleanup steps now appear in the build UI
2. **Live Log Streaming** - Logs update in real-time during build execution
3. **Fixed Polling** - SWR configuration was blocking all polling requests

## Key Decisions

### System Step Indices
- Used negative indices for pre-build steps: `CLONE_STEP_INDEX = -2`
- Used max int for post-build steps: `CLEANUP_STEP_INDEX = i32::MAX - 1`
- This ensures proper ordering: Clone â†’ User Steps â†’ Cleanup

### Why Not WebSocket for Logs?
- Incremental polling simpler to implement and maintain
- 1-second polling provides near real-time feel
- WebSocket would be overkill for this use case
- Polling works reliably across all environments

## Changes

### Backend (`crates/oore-server/src/worker/build_processor.rs`)
- Added constants for system step indices
- Create "Clone Repository" step before cloning
- Write clone success/failure to log files
- Create "Cleanup" step at end of build
- Updated `cleanup_and_fail()` to also track cleanup step
- Fixed step status bug: filter by `step_index` instead of array slicing
- Added error message when steps fail

### Backend (`crates/oore-server/src/routes/builds.rs`)
- Added `offset` query parameter to `/logs/content` endpoint
- Returns only lines after offset for incremental fetching
- Returns total line count for next offset

### Backend (`crates/oore-core/src/pipeline/executor.rs`)
- Flush log files after each line write for live streaming

### Frontend (`web/src/components/builds/build-step-item.tsx`)
- Added system step detection (Clone/Cleanup)
- Special icons for system steps (Download for Clone, Delete for Cleanup)
- Visual distinction: italic text, "System" badge
- Auto-expand steps when they start running

### Frontend (`web/src/components/builds/build-logs-section.tsx`)
- Added `overflow-visible` to Card to prevent clipping

### Frontend (`web/src/components/ui/scroll-area.tsx`)
- Fixed ScrollArea to properly constrain content with maxHeight
- Viewport now uses `max-h-[inherit]` and `overflow-auto`

### Frontend (`web/src/app/(auth)/layout.tsx`)
- **Critical fix**: Changed `dedupingInterval` from 120000ms to 1000ms
- The 2-minute deduping was blocking ALL polling requests

### Frontend (`web/src/lib/api/builds.ts`)
- Updated `useBuildStepLogs` to accept `isStepRunning` parameter
- Running steps poll every 1 second (vs 2 seconds for completed)

### Frontend (`web/src/lib/api/types.ts`)
- Updated `BuildLogContent` type with `step_index` and `line_count`

## Bug Fixes

### SWR Polling Completely Broken (Critical)
**Problem**: Steps and logs never updated without manual refresh.

**Root Cause**: `dedupingInterval: 120000` (2 minutes) in SWR config blocked ALL polling. SWR skips duplicate requests within this window, so 2-second polling intervals were ignored.

**Fix**: Changed to `dedupingInterval: 1000` (1 second).

### Step Status Bug (Critical)
**Problem**: When a step failed, ALL steps (including the current one) were incorrectly marked as "skipped" instead of just remaining steps.

**Root Cause**: The `steps` array included the Clone system step, but the loop index `i` was from user scripts. When using `steps[(i + 1)..]`, it used `i` as an array index but the array indices didn't match user step indices because Clone was at array index 0.

**Fix**: Changed to filter steps by `step_index` instead of using array slicing:
```rust
for remaining in steps.iter().filter(|s| {
    s.step_index > current_step_index && s.step_index < CLEANUP_STEP_INDEX
}) {
```

### Missing Error Message
**Problem**: Failed builds had no error message shown in UI.

**Fix**: Added `BuildRepo::set_error()` call when a step fails with non-zero exit code:
```rust
let error_msg = format!("Step '{}' failed with exit code {}", step_name, step_result.exit_code);
BuildRepo::set_error(db, &build.id, &error_msg).await?;
```

### Logs Not Live (Buffering Issue)
**Problem**: Log files were buffered and only visible after step completed.

**Root Cause**: `BufWriter` only flushed at the END of the spawned task.

**Fix**: Flush after each line write in `executor.rs`:
```rust
let _ = stdout_writer.write_all(line.as_bytes()).await;
let _ = stdout_writer.flush().await;  // Added
```

### ScrollArea Overflow Issue
**Problem**: Expanded log content overflowed behind other steps instead of scrolling.

**Root Cause**: base-ui ScrollArea Viewport had `size-full` which didn't respect parent's maxHeight.

**Fix**: Changed Viewport to use `h-full max-h-[inherit] overflow-auto`.

## Files Modified

- `crates/oore-server/src/worker/build_processor.rs`
- `crates/oore-server/src/routes/builds.rs`
- `crates/oore-core/src/pipeline/executor.rs`
- `web/src/app/(auth)/layout.tsx`
- `web/src/components/builds/build-step-item.tsx`
- `web/src/components/builds/build-logs-section.tsx`
- `web/src/components/ui/scroll-area.tsx`
- `web/src/lib/api/builds.ts`
- `web/src/lib/api/types.ts`

## Testing

- All 24 oore-server tests pass
- Frontend builds successfully
- Manually verified:
  - Clone step appears first with logs
  - Steps update in real-time
  - Logs stream live during execution
  - Cleanup step appears at end
  - Failed builds show error message
  - Log viewer scrolls properly

## Next Steps

1. Consider adding step duration display for Clone/Cleanup
2. Potentially add more detailed clone output (git progress)
3. Add WebSocket support for even faster updates (optional)
