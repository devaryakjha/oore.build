# Progress: 2026-01-26

## Session 1: GitLab Automated Setup Flow

### Summary
Implemented automated GitLab OAuth setup flow matching the GitHub pattern. Users now run a single `oore gitlab setup` command that opens a browser, polls for completion, and shows success in the terminal.

### What Was Built

**New Command**: `oore gitlab setup [--instance URL]`
- Opens browser automatically to GitLab OAuth authorization page
- Shows spinner while waiting for authorization
- Polls server every 2 seconds for completion (up to 10 minutes)
- Displays success with instance URL and username when complete

**Removed Commands**: `oore gitlab connect` and `oore gitlab callback`
- Manual two-step flow replaced by automated single-step flow

**Server Endpoints**:
- `POST /api/gitlab/setup` - Initiates setup, returns auth URL and state token
- `GET /api/gitlab/setup/status?state=X` - Public polling endpoint for CLI

**Browser Callback**:
- `/setup/gitlab/callback` now auto-exchanges code for tokens (like GitHub)
- Shows branded success page when complete
- CLI detects completion via polling, no manual URL copying needed

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Replace connect/callback with setup | Simpler CLI, matches GitHub UX |
| Public status endpoint with state-as-auth | Same pattern as GitHub, enables polling without exposing admin token |
| Auto-exchange in browser callback | Eliminates manual copy-paste step |
| Reuse OAuthState.app_id/app_name for user_id/username | No database schema changes needed |

### Files Modified

**CLI**:
- `crates/oore-cli/src/commands/gitlab.rs` - Replaced Connect/Callback with Setup command

**Server**:
- `crates/oore-server/src/routes/gitlab_oauth.rs` - Added `setup()` and `get_setup_status()` endpoints, updated `handle_callback()` to mark state as completed
- `crates/oore-server/src/routes/oauth_callback.rs` - Changed `gitlab_callback_handler` to auto-exchange code, added `gitlab_success_page()` function
- `crates/oore-server/src/main.rs` - Registered new routes

### Code Review Findings & Fixes

1. **Fixed**: Missing instance_url validation - now returns error instead of silently defaulting to gitlab.com
2. **Noted**: State tokens in URL parameters - acceptable given HTTPS requirement and short TTL
3. **Noted**: Race condition with concurrent setups - same as GitHub, acceptable risk
4. **Fixed**: URL normalization bug - `list_projects`, `enable_project`, `disable_project`, and `refresh_token` endpoints weren't normalizing instance URLs before database lookup, causing "NOT_CONFIGURED" errors when CLI passed URLs without trailing slash while stored URLs had trailing slash from `Url::parse()` normalization

### Testing

- All 24 existing tests pass
- Build successful with only unrelated warnings
- Live testing completed with `gitlab.arya.run`:
  - `oore gitlab setup --instance https://gitlab.arya.run` - Opens browser, polls, shows success
  - `oore gitlab projects --instance https://gitlab.arya.run` - Now works with URL normalization fix
  - `oore gitlab enable 1` - Successfully enables CI for project
  - `oore gitlab projects` - Auto-detects single instance, no `--instance` needed

---

## Session 2: GitLab UX Improvements

### Summary
Improved GitLab CLI UX by making `--instance` optional when only one GitLab instance is configured.

### What Was Changed

**Instance Auto-Detection**: When only one GitLab instance is configured, CLI commands auto-detect it:
```bash
# Before (always required)
oore gitlab projects --instance https://gitlab.arya.run

# After (auto-detected)
oore gitlab projects
```

**Behavior by scenario**:
| Scenario | Result |
|----------|--------|
| 0 instances, `setup` | Defaults to gitlab.com |
| 0 instances, other commands | Error: "Run 'oore gitlab setup' first" |
| 1 instance | Auto-detected |
| Multiple instances | Error listing available instances |
| `--instance` provided | Uses that instance |

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Auto-detect only for single instance | Multiple instances need explicit selection to avoid confusion |
| `setup` defaults to gitlab.com | New users most likely connecting to gitlab.com first |
| Error message lists available instances | Helps user know what to specify |

### Files Modified

- `crates/oore-cli/src/commands/gitlab.rs` - Made `--instance` optional, added `resolve_instance()` helper

### Documentation Updated

- `docs/src/content/docs/integrations/gitlab.mdx` - Rewrote to reflect new `setup` command flow (removed connect/callback), added auto-detection tip
- `docs/src/content/docs/reference/cli.mdx` - Updated GitLab section with new commands, added auto-detection callout, removed deprecated connect/callback commands

### Comparison: GitHub vs GitLab

| Aspect | GitHub | GitLab |
|--------|--------|--------|
| Instances | Single (github.com only) | Multiple (gitlab.com + self-hosted) |
| App creation | Auto (manifest flow) | Manual (create in GitLab UI) |
| Setup command | `oore github setup` | `oore gitlab register` (self-hosted) + `oore gitlab setup` |
| Instance param | Not needed | Auto-detected if single, required if multiple |

---

## Session 3: Web Dashboard Implementation

### Summary
Implemented a complete web dashboard for Oore CI/CD with feature parity to the CLI. The dashboard uses Next.js 16 with React 19, shadcn/ui components, SWR for data fetching, and follows an industrial/utilitarian aesthetic with amber/orange accents.

### What Was Built

**Authentication System**:
- Login page with admin token input
- Token stored in localStorage
- Protected route wrapper that redirects to login if not authenticated
- Auto-logout on 401 responses

**Layout & Navigation**:
- Responsive sidebar with collapsible mobile view
- Theme toggle (dark/light mode)
- Header with sidebar trigger and theme toggle
- Logo and branding

**Dashboard Page** (`/`):
- Setup status cards (GitHub App, GitLab OAuth, encryption)
- Stats cards (repositories, builds, success rate, integrations)
- Recent builds list with status badges
- Quick actions (trigger build, add repo, view settings)

**Repositories** (`/repositories`, `/repositories/[id]`, `/repositories/new`):
- Repository list with table showing status, provider, last update
- Repository detail with webhook URL display, copy button
- Recent builds for each repository
- Add repository form with GitHub/GitLab provider selection
- Delete with confirmation dialog
- Trigger build action

**Builds** (`/builds`, `/builds/[id]`):
- Build list with filtering by repository
- Build detail with timing information, branch, commit
- Build status badges (pending, running, success, failure, cancelled)
- Cancel build action for running/pending builds
- Polling for status updates (5s interval)

**Webhooks** (`/webhooks`):
- Webhook events list with status (processed, pending, error)
- Provider icons (GitHub/GitLab)
- Event type, repository, delivery ID display

**Settings** (`/settings`, `/settings/github`, `/settings/gitlab`):
- Settings overview with GitHub and GitLab status cards
- GitHub App setup wizard with polling for completion
- GitHub installations list with sync button
- GitLab OAuth setup wizard with polling
- GitLab instances list with token refresh capability

### Key Technical Decisions

| Decision | Rationale |
|----------|-----------|
| localStorage for token | Simple, sufficient for admin-only dashboard |
| SWR for data fetching | Auto-deduplication, caching, revalidation per Vercel best practices |
| Polling for OAuth flows | Matches CLI pattern, 2s interval with 10min timeout |
| Polling for build status | 5s interval when shouldPoll=true |
| Modified shadcn components | Added `asChild` support to Button, DropdownMenu, SidebarMenuButton for Link integration |

### Component Modifications

The project uses @base-ui/react shadcn preset which doesn't support `asChild` pattern by default. Added support to:

1. **Button** (`components/ui/button.tsx`):
   - Rewrote to use @radix-ui/react-slot for `asChild` support
   - Added `icon-xs` and `icon-sm` size variants

2. **DropdownMenuTrigger/DropdownMenuItem** (`components/ui/dropdown-menu.tsx`):
   - Added `asChild` prop that uses `render` prop internally

3. **SidebarMenuButton** (`components/ui/sidebar.tsx`):
   - Added `asChild` prop that passes children to `render` prop

4. **InputGroupButton** (`components/ui/input-group.tsx`):
   - Added `render` prop support for @base-ui integration

### Files Created

**API Layer** (`lib/api/`):
- `client.ts` - API client with auth handling
- `types.ts` - TypeScript interfaces for all API responses
- `setup.ts` - Setup status hooks
- `repositories.ts` - Repository CRUD hooks
- `builds.ts` - Build management hooks
- `webhooks.ts` - Webhook events hooks
- `github.ts` - GitHub App management hooks
- `gitlab.ts` - GitLab OAuth management hooks

**Shared** (`lib/`):
- `constants.ts` - API base URL
- `format.ts` - Date/time formatting utilities
- `auth.ts` - Token storage utilities

**Hooks**:
- `hooks/use-mobile.tsx` - Mobile detection hook

**Layout Components** (`components/layout/`):
- `theme-toggle.tsx` - Dark/light mode toggle
- `header.tsx` - Top header bar
- `app-sidebar.tsx` - Main navigation sidebar

**Shared Components** (`components/shared/`):
- `empty-state.tsx` - Empty state with icon and action
- `loading-skeleton.tsx` - Card and table loading skeletons
- `confirm-dialog.tsx` - Confirmation dialogs for destructive actions

**Feature Components**:
- `components/builds/build-status.tsx` - Status badges
- `components/dashboard/setup-status.tsx` - Setup progress cards
- `components/dashboard/recent-builds.tsx` - Recent builds list
- `components/dashboard/quick-actions.tsx` - Action buttons
- `components/dashboard/stats-cards.tsx` - Statistics display

**Pages**:
- `app/login/page.tsx` - Token entry
- `app/(auth)/layout.tsx` - Protected layout with sidebar
- `app/(auth)/page.tsx` - Dashboard
- `app/(auth)/repositories/page.tsx` - Repository list
- `app/(auth)/repositories/[id]/page.tsx` - Repository detail
- `app/(auth)/repositories/new/page.tsx` - Add repository
- `app/(auth)/builds/page.tsx` - Build list
- `app/(auth)/builds/[id]/page.tsx` - Build detail
- `app/(auth)/webhooks/page.tsx` - Webhook events
- `app/(auth)/settings/page.tsx` - Settings overview
- `app/(auth)/settings/github/page.tsx` - GitHub integration
- `app/(auth)/settings/gitlab/page.tsx` - GitLab integration

### Dependencies Added

```bash
bun add swr react-hook-form @hookform/resolvers zod @radix-ui/react-slot
```

### shadcn Components Installed

```bash
bunx --bun shadcn@latest add sidebar sheet tabs table skeleton avatar tooltip progress sonner form switch checkbox scroll-area dialog
```

### Build Verification

- TypeScript compilation: ✓
- Next.js build: ✓ (12 routes generated)
- Dev server: ✓ (starts on localhost:3000)

### Next Steps

1. Test against running Rust server
2. Add toast notifications for all actions
3. Implement keyboard shortcuts
4. Add error boundaries for graceful error handling
5. Consider adding build logs streaming when available

---

## Session 4: Web Dashboard UI Review Fixes

### Summary
Implemented fixes from a comprehensive UI review that identified security concerns, UX logic issues, and design inconsistencies.

### What Was Fixed

**Security (console.error removal)**:
Removed all `console.error(error)` calls that could expose sensitive API error details in production. The user-facing toast messages are retained.

Files fixed:
- `app/(auth)/builds/[id]/page.tsx`
- `app/(auth)/repositories/[id]/page.tsx`
- `app/(auth)/repositories/page.tsx`
- `app/(auth)/repositories/new/page.tsx`
- `app/(auth)/settings/github/page.tsx`
- `app/(auth)/settings/gitlab/page.tsx`

**Security (URL validation)**:
Created `lib/url.ts` with utilities for validating external URLs from API responses:
- `validateExternalUrl()` - Returns URL if valid http/https, null otherwise
- `isValidExternalUrl()` - Boolean check
- `validateGitUrl()` - Handles git/ssh URLs too

**UX: Settings Page Dead-End Buttons**:
The Encryption and Admin Token cards had buttons linking to `/settings` (the same page), creating a confusing dead-end. Fixed by:
- Adding `serverOnly` prop to `SettingCard` component
- Replacing buttons with "Configured via server environment variables" text
- Users now understand these are server-side only settings

**UX: Build Logs "Coming Soon" Badge**:
The build logs placeholder was confusing ("logs will be available once implemented"). Fixed by:
- Adding prominent "Coming Soon" badge in card header
- Clearer message: "Build execution and log streaming are not yet implemented"
- Centered text with better visual hierarchy

**UX: GitLab Webhook Message Clarification**:
The message about webhook configuration was confusing. Reworded from:
> "If you enabled via `oore gitlab enable`, the webhook was created automatically..."

To:
> "Copy this URL and add it to your GitLab project's webhook settings, or use the CLI command `oore gitlab enable` to configure it automatically."

**Design: Info Box Background**:
Standardized info box backgrounds from `bg-primary/5` to `bg-muted/50` for consistency with other muted UI elements.

**Design: Helper Text Sizing**:
Standardized form helper text to use `text-sm` for better readability (was `text-xs` in some places).

### Key Decisions

| Decision | Rationale |
|----------|-----------|
| Remove console.error entirely | Toast messages already inform users; no need to log error objects in production |
| URL validation as utility | Central place for validation, can be extended with allowlist if needed |
| "serverOnly" pattern | Reusable for any future server-side-only settings |
| Keep localStorage for token | Self-hosted admin tool with limited XSS surface; httpOnly cookies require backend changes |

### Files Created

- `lib/url.ts` - URL validation utilities

### Files Modified

- `app/(auth)/settings/page.tsx` - Added serverOnly prop, fixed info box bg
- `app/(auth)/builds/[id]/page.tsx` - Coming Soon badge, removed console.error
- `app/(auth)/repositories/[id]/page.tsx` - Clarified webhook message, removed console.error
- `app/(auth)/repositories/page.tsx` - Removed console.error
- `app/(auth)/repositories/new/page.tsx` - Fixed helper text sizing, removed console.error
- `app/(auth)/settings/github/page.tsx` - Removed console.error
- `app/(auth)/settings/gitlab/page.tsx` - Removed console.error

### Verification

- Build: ✓ `bun run build` passes with all 12 routes
- All changes verified in code

---

## Session 5: Web Interface Guidelines & Accessibility Compliance

### Summary
Applied Web Interface Guidelines, Vercel React Best Practices, and accessibility standards to fix additional issues found in comprehensive review.

### What Was Fixed

**Accessibility: aria-labels for icon-only buttons**

Added `aria-label` attributes to all icon-only buttons throughout the app:

| File | Button | aria-label |
|------|--------|------------|
| `repositories/[id]/page.tsx` | Copy webhook URL | "Copy webhook URL" |
| `repositories/[id]/page.tsx` | Back buttons (3x) | "Back to repositories" |
| `repositories/page.tsx` | Dropdown trigger | "Repository actions" |
| `repositories/new/page.tsx` | Back button | "Back to repositories" |
| `builds/[id]/page.tsx` | Back buttons (3x) | "Back to builds" |
| `settings/github/page.tsx` | Back buttons (2x) | "Back to settings" |
| `settings/gitlab/page.tsx` | Back buttons (2x) | "Back to settings" |

**i18n: Intl.DateTimeFormat for dates**

Replaced hardcoded `'en-US'` locale with `undefined` to use browser's locale:
- `formatDate()` - now uses `Intl.DateTimeFormat(undefined, ...)`
- `formatDateTime()` - now uses `Intl.DateTimeFormat(undefined, ...)`
- `formatDistanceToNow()` fallback - now uses `Intl.DateTimeFormat`

**Dark Mode: color-scheme & theme-color**

- Added `colorScheme: 'light dark'` style to `<html>` for proper scrollbar/input styling
- Added `viewport.themeColor` with media queries for light/dark themes
- Used Next.js 16 `Viewport` export (not deprecated `metadata.themeColor`)

**Typography: Proper ellipsis**

- Changed "Please wait..." to "Please wait…" (proper ellipsis character)

### Files Modified

- `app/layout.tsx` - viewport export, colorScheme
- `lib/format.ts` - Intl.DateTimeFormat
- `components/shared/confirm-dialog.tsx` - ellipsis
- `app/(auth)/repositories/[id]/page.tsx` - aria-labels
- `app/(auth)/repositories/page.tsx` - aria-label
- `app/(auth)/repositories/new/page.tsx` - aria-label
- `app/(auth)/builds/[id]/page.tsx` - aria-labels
- `app/(auth)/settings/github/page.tsx` - aria-labels
- `app/(auth)/settings/gitlab/page.tsx` - aria-labels

### Guidelines Applied

| Guideline | Rule | Status |
|-----------|------|--------|
| Web Interface | Icon-only buttons need aria-label | ✓ Fixed |
| Web Interface | Use Intl.DateTimeFormat | ✓ Fixed |
| Web Interface | color-scheme on html | ✓ Fixed |
| Web Interface | theme-color meta | ✓ Fixed |
| Web Interface | Ellipsis not ... | ✓ Fixed |
| Vercel React | client-swr-dedup | ✓ Already good |
| Vercel React | bundle-barrel-imports | ✓ Already good |

### Verification

- Build: ✓ `bun run build` passes with no warnings
- All 12 routes generated successfully

---

## Session 6: Final Web Interface Guidelines Pass

### Summary
Final review pass to fix remaining typography and form guidelines compliance issues.

### What Was Fixed

**Typography: Replace all `...` with proper `…` ellipsis**

Fixed 15 instances of three-period `...` that should be proper ellipsis `…`:

| File | Text |
|------|------|
| `login/page.tsx` | "Validating…" |
| `webhooks/page.tsx` | Truncated delivery ID |
| `repositories/new/page.tsx` | "Creating…", "Search repositories…", "Search projects…" |
| `repositories/[id]/page.tsx` | "Triggering…" |
| `builds/[id]/page.tsx` | "In progress…" |
| `settings/github/page.tsx` | "Waiting for GitHub…", "Syncing…", "Starting…", "Waiting for you to install…" |
| `settings/gitlab/page.tsx` | "Waiting for GitLab authorization…", "Refreshing…", "Registering…" |

**Forms: Placeholders end with `…`**

Updated placeholders to show example patterns ending with ellipsis:
- `login/page.tsx`: "Enter your admin token…"
- `repositories/new/page.tsx`: "myorg…", "my-flutter-app…", "main…", "Enter a secret token…"

**Forms: Added autocomplete attributes**

- `login/page.tsx`: Added `autoComplete="current-password"` to token input
- `repositories/new/page.tsx`: Added `autoComplete="off"` to webhook secret

**Accessibility: Added aria-label to filter Select**

- `builds/page.tsx`: Added `aria-label="Filter by repository"` to SelectTrigger

### Files Modified

- `app/login/page.tsx` - Ellipsis, placeholder, autocomplete
- `app/(auth)/webhooks/page.tsx` - Ellipsis in truncated text
- `app/(auth)/repositories/new/page.tsx` - Ellipsis in loading states, placeholders, autocomplete
- `app/(auth)/repositories/[id]/page.tsx` - Ellipsis in loading state
- `app/(auth)/builds/page.tsx` - aria-label on filter
- `app/(auth)/builds/[id]/page.tsx` - Ellipsis in status text
- `app/(auth)/settings/github/page.tsx` - Ellipsis in all loading/waiting states
- `app/(auth)/settings/gitlab/page.tsx` - Ellipsis in all loading/waiting states

### Guidelines Applied

| Guideline | Rule | Status |
|-----------|------|--------|
| Typography | Use ellipsis `…` not `...` | ✓ Fixed (15 instances) |
| Forms | Placeholders end with `…` | ✓ Fixed |
| Forms | Inputs need `autocomplete` | ✓ Fixed |
| Accessibility | Form controls need aria-label | ✓ Fixed |

### Verification

- Build: ✓ `bun run build` passes with no warnings
- Grep for `...`: 0 matches in app directory
- All 12 routes generated successfully

---

## Session 7: Security - URL Validation Implementation

### Summary
Final security review pass to ensure the URL validation helper created earlier is actually being used on external URLs from API responses.

### What Was Fixed

**URL Validation Applied to External Links**

The `validateExternalUrl` and `validateGitUrl` helpers from `lib/url.ts` are now used to validate all external URLs from API responses before rendering them in `href` attributes:

| File | URL Source | Validation |
|------|------------|------------|
| `settings/github/page.tsx` | `app.html_url` | `validateExternalUrl()` |
| `repositories/[id]/page.tsx` | `repo.clone_url` | `validateGitUrl()` |
| `repositories/[id]/page.tsx` | GitLab webhook settings URL | `validateExternalUrl()` |

**Defensive Rendering Pattern**

External links now use this pattern:
```tsx
{validateExternalUrl(url) && (
  <a href={validateExternalUrl(url)!} target="_blank" rel="noopener noreferrer">
    ...
  </a>
)}
```

This ensures:
1. Only valid http/https URLs are rendered as clickable links
2. Malformed or javascript: URLs are blocked
3. If API is compromised, malicious URLs won't be clickable

**Codebase Verification**

Verified no remaining issues:
- No `transition: all` anti-pattern
- All `outline-none` have `focus-visible:ring-*` replacements
- No `<div onClick>` or `<span onClick>` patterns
- Images have proper dimensions and alt text
- Hover states present on all button variants

### Files Modified

- `app/(auth)/settings/github/page.tsx` - Import and use `validateExternalUrl`
- `app/(auth)/repositories/[id]/page.tsx` - Import and use `validateGitUrl`, `validateExternalUrl`

### Guidelines Applied

| Guideline | Rule | Status |
|-----------|------|--------|
| Security | Validate external URLs from API | ✓ Fixed |
| Web Interface | No anti-patterns | ✓ Verified |

### Verification

- Build: ✓ `bun run build` passes with no warnings
- All 12 routes generated successfully
- URL validation helper now actively used on all external links
