---
title: GitLab Integration
description: Set up GitLab webhooks for automated builds from push events and merge requests
banner:
  content: |
    <strong>Experimental</strong> — Webhooks are received but builds don't run yet. For contributors only.
---

import { Steps, Tabs, TabItem, Aside } from '@astrojs/starlight/components';

<Aside type="caution">
The GitLab integration can receive webhooks and store events, but **build execution is not implemented**. Setting this up will not give you working CI/CD.
</Aside>

Oore integrates with GitLab using:

- **Webhooks**: For receiving push and merge request events
- **OAuth**: For cloning private repositories and automatic webhook management

GitLab webhooks use token-based authentication (simpler than GitHub's HMAC signatures).

## Quick Setup (OAuth)

The recommended way to set up GitLab is using OAuth, which automatically creates webhooks.

<Steps>

1. **Create GitLab OAuth Application**

   <Tabs>
     <TabItem label="gitlab.com">
       Configure environment variables on the server:

       ```bash
       # /etc/oore/oore.env
       OORE_GITLAB_CLIENT_ID=your-application-id
       OORE_GITLAB_CLIENT_SECRET=your-application-secret
       ```

       Create the application at GitLab - Settings - Applications with:

       | Field | Value |
       |-------|-------|
       | Name | Oore CI |
       | Redirect URI | `https://your-server.com/setup/gitlab/callback` |
       | Confidential | Yes |
       | Scopes | `api`, `read_repository` |
     </TabItem>
     <TabItem label="Self-Hosted">
       Create the OAuth application in your GitLab instance, then configure it via the API:

       ```bash
       curl -X POST https://your-server.com/api/gitlab/instances \
         -H "Authorization: Bearer $OORE_ADMIN_TOKEN" \
         -H "Content-Type: application/json" \
         -d '{
           "base_url": "https://gitlab.mycompany.com",
           "client_id": "YOUR_CLIENT_ID",
           "client_secret": "YOUR_CLIENT_SECRET"
         }'
       ```
     </TabItem>
   </Tabs>

2. **Run setup from dashboard**

   Navigate to **Settings > Integrations > GitLab** and click "Connect GitLab". This opens your browser for OAuth authorization.

3. **Enable CI for projects**

   Once connected, navigate to **Repositories > Add Repository** and select GitLab as the provider. Choose from your accessible projects.

4. **Push code**

   ```bash
   git push origin main
   ```

   View builds in the dashboard under **Builds**.

</Steps>

## API Reference

For programmatic access, use the REST API:

### Setup and Authentication

| Endpoint | Method | Description |
|----------|--------|-------------|
| `GET /api/gitlab/status` | GET | Show credentials status for all instances |
| `POST /api/gitlab/instances` | POST | Register a self-hosted GitLab instance |
| `POST /api/gitlab/setup/start` | POST | Start OAuth setup flow |
| `POST /api/gitlab/refresh` | POST | Refresh OAuth token |
| `DELETE /api/gitlab/credentials/:id` | DELETE | Remove credentials |

### Project Management

| Endpoint | Method | Description |
|----------|--------|-------------|
| `GET /api/gitlab/projects` | GET | List accessible projects |
| `POST /api/gitlab/projects/:id/enable` | POST | Enable CI for a project |
| `POST /api/gitlab/projects/:id/disable` | POST | Disable CI for a project |

All endpoints require `Authorization: Bearer <OORE_ADMIN_TOKEN>` header.

:::tip[Instance Auto-Detection]
When only one GitLab instance is configured, the `instance` parameter is optional. When multiple instances are configured, you must specify `instance` in requests.
:::

:::tip[Automatic Token Refresh]
The web dashboard automatically refreshes expired GitLab OAuth tokens when you select a GitLab instance. If automatic refresh fails, you can manually refresh from **Settings > GitLab**.
:::

## How It Works

```
GitLab                          oored                      Build
  │                               │                          │
  │  POST /webhooks/gitlab/:id    │                          │
  ├──────────────────────────────▶│                          │
  │                               │ 1. Verify token          │
  │                               │ 2. Store event           │
  │                               │ 3. Queue for processing  │
  │        {"status":"ok"}        │                          │
  │◀──────────────────────────────┤                          │
```

### Security: Token Storage

GitLab tokens are stored securely:

1. Token sent in `X-Gitlab-Token` header
2. Oore stores `HMAC-SHA256(token, pepper)` in database
3. On verification, compute HMAC and compare

:::note
Even if the database is compromised, original tokens cannot be recovered.
:::

### Event Types

| Event | Trigger |
|-------|---------|
| Push Hook | Code pushed |
| Merge Request Hook | MR opened/updated/merged |
| Tag Push Hook | New tag created |

## GitLab.com vs Self-Hosted

<Tabs>
  <TabItem label="GitLab.com">
    Configure environment variables for OAuth:
    ```bash
    OORE_GITLAB_CLIENT_ID=your-app-id
    OORE_GITLAB_CLIENT_SECRET=your-app-secret
    ```

    Then use the dashboard to connect GitLab.
  </TabItem>
  <TabItem label="Self-Hosted">
    Register OAuth app credentials via API:
    ```bash
    curl -X POST https://your-server.com/api/gitlab/instances \
      -H "Authorization: Bearer $OORE_ADMIN_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{
        "base_url": "https://gitlab.mycompany.com",
        "client_id": "YOUR_CLIENT_ID",
        "client_secret": "YOUR_CLIENT_SECRET"
      }'
    ```

    Then use the dashboard to connect.

    Optional security settings in `/etc/oore/oore.env`:
    ```bash
    OORE_GITLAB_ALLOWED_HOSTS=gitlab.mycompany.com,gitlab.internal.com
    OORE_GITLAB_CA_BUNDLE=/etc/ssl/certs/internal-ca.pem
    ```
  </TabItem>
</Tabs>

## Troubleshooting

### Webhooks Not Received

- Check URL is publicly accessible
- Token must match exactly (case-sensitive)
- SSL certificate must be valid

View logs in GitLab - Settings - Webhooks - Recent events

### Token Verification Failures

Update the webhook secret via the dashboard's repository settings, then update the matching secret in GitLab webhook settings.

## Comparing GitHub vs GitLab

| Feature | GitHub | GitLab |
|---------|--------|--------|
| Webhook auth | HMAC-SHA256 signature | Token header |
| App model | GitHub App (auto-created) | OAuth (manual app creation) |
| Token storage | N/A (signature-based) | HMAC hashed |
| Multiple instances | No (github.com only) | Yes |

## Complete Example (OAuth Flow)

<Steps>
1. **Configure GitLab OAuth in environment**

   For self-hosted GitLab, use the API to register:
   ```bash
   curl -X POST https://your-server.com/api/gitlab/instances \
     -H "Authorization: Bearer $OORE_ADMIN_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "base_url": "https://gitlab.mycompany.com",
       "client_id": "YOUR_CLIENT_ID",
       "client_secret": "YOUR_CLIENT_SECRET"
     }'
   ```

2. **Open dashboard and navigate to Settings > GitLab**

3. **Click "Connect GitLab"**

4. **Authorize in GitLab**

5. **Add repositories via Repositories > Add Repository**

6. **Push code**

   ```bash
   git push origin main
   ```

7. **View builds in dashboard**
</Steps>

## Manual Webhook Setup (Without OAuth)

If you prefer not to use OAuth, you can set up webhooks manually:

<Steps>

1. **Add repository via API**

   ```bash
   curl -X POST https://your-server.com/api/repositories \
     -H "Authorization: Bearer $OORE_ADMIN_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "provider": "gitlab",
       "owner": "myuser",
       "name": "my-project",
       "webhook_secret": "my-secure-secret",
       "gitlab_project_id": 12345678
     }'
   ```

2. **Get webhook URL from response**

   The response includes the webhook URL to configure in GitLab.

3. **Configure in GitLab**

   Go to Settings - Webhooks in your GitLab project:

   | Field | Value |
   |-------|-------|
   | URL | Webhook URL from step 2 |
   | Secret token | Same secret from step 1 |
   | Push events | Yes |
   | Merge request events | Yes |

4. **Test the webhook**

   Click "Test" - "Push events" in GitLab to verify connectivity.

</Steps>
